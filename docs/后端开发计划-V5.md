# 后端开发计划与步骤（V5）

> V5 聚焦：**标签管理（Tag）/ 窗口回收站（RecycleBin）/ 代理列表（Proxy）** 三大模块的“可联调闭环”。
> 
> 目标：让前端对应页面从“延期/空数据/演示”升级为“真实可用”，并且 **IPC 文档、后端实现、前端 API 三者一致**。

---

## 0. 当前现状（基于代码与文档）

### 0.1 IPC 文档已定义但后端未注册的命令
`docs/IPC-接口说明.md` 已定义：

- Tag：`get_tags/create_tag/update_tag/delete_tag`
- Proxy：`get_proxies/get_proxy/create_proxy/update_proxy/delete_proxy/test_proxy`
- RecycleBin：`get_recycle_bin/restore_profile/batch_restore_profiles/permanently_delete_profile/batch_permanently_delete_profiles/empty_recycle_bin`

但当前 `src-tauri/src/lib.rs`：

- ✅ Profile/Settings/Browser/Window/Group 已注册
- ⏳ Tag/RecycleBin/Proxy 命令与服务初始化仍被注释（未接入 `AppState` + 未加入 `invoke_handler`）

### 0.2 后端已有的“基础资产”（可复用）

- ✅ 数据库迁移：`migrations/003_add_tags_and_recycle.sql`
  - tags/profile_tags
  - profiles.deleted_at（软删除）
  - settings.proxy_templates 初始化
- ✅ Service/模块代码已存在：
  - `src-tauri/src/modules/tag.rs`（TagService + profile_tags 关联能力）
  - `src-tauri/src/modules/recycle_bin.rs`（RecycleBinService，支持 restore/batch/permanent delete）
  - `src-tauri/src/modules/proxy_template.rs`（ProxyTemplateService，当前存储在 settings JSON）

### 0.3 关键差距（V5 必须解决）

- **Tag**：服务已完成，但 **IPC 未接入**（导致前端 Tag API 永远调用失败）。
- **RecycleBin**：服务已完成，但 **IPC 未接入**；同时 **回收站列表未返回 deletedAt 字段**（目前只按 deleted_at 排序但未输出）。
- **Proxy**：当前后端实现为 `proxy_templates`（settings JSON），而 IPC 文档/未来 UI 需要的是“代理列表（Proxy entity）”体系，并包含 `test_proxy`。

---

## 1. V5 交付定义（Definition of Done）

### 1.1 Tag（标签管理）

- [ ] `get_tags/create_tag/update_tag/delete_tag` 可调用
- [ ] `get_tags` 返回 `windowCount`（基于 `profile_tags` 关联计数，排除已删除窗口）
- [ ] 名称唯一性校验、错误信息可直接展示

### 1.2 RecycleBin（窗口回收站）

- [ ] 软删除链路闭环：`delete_profile` 进入回收站（`deleted_at` 写入）
- [ ] 回收站列表：`get_recycle_bin` 返回包含 `deletedAt`
- [ ] 恢复/批量恢复/永久删除/清空 回收站全可用
- [ ] 批量接口返回 `BatchResult`（逐项结果）

### 1.3 Proxy（代理列表）

- [ ] `get_proxies/get_proxy/create_proxy/update_proxy/delete_proxy/test_proxy` 可调用
- [ ] 数据结构与 IPC 文档对齐（至少涵盖 type/host/port/username/password/tag/remark/status/createdAt）
- [ ] `test_proxy` 至少能做“连通性/延迟”检测（先 minimal，后续可扩展到真实出口 IP/归属地）

---

## 2. 设计决策（V5 先做对齐，避免返工）

### 2.1 Proxy：从“settings JSON 模板”升级为“proxies 表”（推荐）

原因：

- IPC 文档定义的是 `Proxy[]` 实体（带状态、检测结果、使用次数等），不适合继续塞在 settings JSON。
- 前端 ProxyManagement 页已经按“列表/筛选/状态”设计（即使当前延期），也更匹配表结构。

V5 建议：

- 新增 `proxies` 表，作为代理列表的权威来源
- **兼容迁移**：读取 settings.proxy_templates（若存在）并导入到 proxies 表（可选）

### 2.2 RecycleBin：回收站返回 deletedAt

IPC 文档里 `RecycledProfile` 包含 `deletedAt`。V5 要做：

- 查询时带出 `deleted_at`，并在返回结构中提供 `deletedAt`
- 约定 `deletedAt` 为 RFC3339（与其他时间字段一致）

---

## 3. 数据库设计与迁移（DB Gate）

### 3.1 迁移清单

- 已有：`003_add_tags_and_recycle.sql`
- 新增（建议）：`004_add_proxies.sql`

### 3.2 `004_add_proxies.sql`（建议表结构）

- `proxies`：
  - `id TEXT PRIMARY KEY`
  - `type TEXT NOT NULL`（http/https/socks5/direct）
  - `source TEXT NOT NULL DEFAULT 'custom'`
  - `tag TEXT NOT NULL DEFAULT ''`
  - `host TEXT NOT NULL`
  - `port TEXT NOT NULL`
  - `username TEXT NULL`
  - `password TEXT NULL`
  - `ip_address TEXT NULL`
  - `location TEXT NULL`
  - `used_count INTEGER NOT NULL DEFAULT 0`
  - `auto_check INTEGER NOT NULL DEFAULT 0`
  - `expire_at TEXT NULL`（RFC3339）
  - `bind_window TEXT NULL`（预留：绑定窗口 id）
  - `remark TEXT NOT NULL DEFAULT ''`
  - `status TEXT NOT NULL DEFAULT 'active' CHECK(status IN ('active','expired','error'))`
  - `created_at TEXT NOT NULL`
  - `updated_at TEXT NOT NULL`

索引建议：

- `(status)`、`(type)`、`(tag)`、`(updated_at)`

### 3.3 `003_add_tags_and_recycle.sql` 的稳定性修正建议

当前 migration 含：

- `ALTER TABLE profiles ADD COLUMN deleted_at TEXT;`

SQLite 对“重复加字段”不友好；V5 建议：

- 在 migration 前先检查 `PRAGMA table_info(profiles)`（如果不做 runtime 检查，就至少保证迁移只跑一次）

---

## 4. Service 与 IPC 设计（实现清单）

### 4.1 Tag 模块（P0）

- **Service 复用**：`TagService` 已具备
- **IPC 命令（需接入 lib.rs）**：
  - `get_tags` → `TagService.list_tags()`
  - `create_tag` → `TagService.create_tag(dto)`
  - `update_tag` → `TagService.update_tag(id, dto)`
  - `delete_tag` → `TagService.delete_tag(id)`

补充建议：

- 事件（可选）：`tag:created/tag:updated/tag:deleted`（用于前端实时刷新）

### 4.2 RecycleBin 模块（P0）

- **Service 复用**：`RecycleBinService` 已具备
- **必须补齐**：回收站列表返回 `deletedAt`
  - 建议定义 `RecycledProfileDto`（包含 Profile 字段 + deletedAt）
- **IPC 命令（需接入 lib.rs）**：
  - `get_recycle_bin`
  - `restore_profile`
  - `batch_restore_profiles`（返回 BatchResult）
  - `permanently_delete_profile`
  - `batch_permanently_delete_profiles`（返回 BatchResult）
  - `empty_recycle_bin`（返回删除条数）

### 4.3 Proxy 模块（P0/P1）

- **新增 ProxyService（推荐）**：以 `proxies` 表为权威存储
- **IPC 命令（按 IPC 文档）**：
  - `get_proxies`：支持列表
  - `get_proxy`：按 id 获取
  - `create_proxy/update_proxy/delete_proxy`
  - `test_proxy`：最小连通性检测

`test_proxy` 最小实现建议（不引入新依赖的方案）：

- 使用 `tokio::net::TcpStream::connect(host:port)`
- 记录耗时作为 latency
- 成功则 `success=true`，失败则 `success=false + error`

后续增强（可选）：

- 引入 HTTP client（例如 reqwest）通过代理访问公共探测服务，返回出口 IP/归属地

---

## 5. 与现有 Profile/Group 的联动点（必须提前定义）

### 5.1 Profile 软删除与回收站

- `delete_profile`：保持“软删除”（写 `deleted_at`）
- `get_profiles`：只返回 `deleted_at IS NULL`
- `get_recycle_bin`：只返回 `deleted_at IS NOT NULL`，并返回 `deletedAt`

### 5.2 Tag 的 windowCount 统计

- 统计口径：
  - `windowCount = profile_tags` 关联数
  - **排除 deleted_at 非空的窗口**（TagService 已按此实现）

### 5.3 Proxy 与窗口的绑定策略（先定义，再实现）

V5 建议先定最小闭环：

- 代理列表独立 CRUD
- 窗口启动时是否支持“绑定某个 proxyId”可作为后续扩展（需要 Profile schema 增加 proxyRef）

---

## 6. 测试与验收（必须可执行）

### 6.1 单元测试（后端）

- Tag：
  - 名称唯一性
  - CRUD
  - windowCount 统计（含 deleted_at 排除）
- RecycleBin：
  - delete_profile → 出现在回收站
  - restore 后从回收站消失
  - permanently_delete 后不可恢复
  - batch 返回逐项结果
- Proxy：
  - CRUD
  - test_proxy（连通/失败）

### 6.2 冒烟测试（前后端联调）

- TagManagement：创建/编辑/删除后列表刷新
- RecycleBin：删除窗口 → 回收站出现 → 恢复 → 列表出现
- ProxyManagement：创建代理 → 列表出现 → 编辑 → 删除

---

## 7. 排期建议（单人后端）

- **Phase V5-0（0.5 天）**：对齐 IPC 文档与实际类型（特别是 Proxy）
- **Phase V5-1（0.5 天）**：接入 Tag IPC（解注释/接入 AppState/注册命令）
- **Phase V5-2（0.5-1 天）**：接入 RecycleBin IPC + 补齐 `deletedAt` 输出
- **Phase V5-3（1-2 天）**：实现 proxies 表 + ProxyService + Proxy IPC
- **Phase V5-4（0.5-1 天）**：`test_proxy` 最小实现 + 单测 + 文档更新

合计：**3-5 天**（不含“真实出口 IP/地理位置”的增强实现）。

---

## 8. 风险与注意事项

- **Proxy 密码敏感信息**：
  - 短期：存储在 DB 明文（最小闭环）
  - 中期：需要加密存储（本地密钥/系统凭据），并确保前端列表展示脱敏
- **RecycleBin 永久删除风险**：
  - 必须二次确认（前端）
  - 后端需校验窗口必须处于 deleted 状态才允许永久删除（当前服务已做）
- **IPC 文档一致性**：
  - V5 完成后必须更新 `docs/IPC-接口说明.md` 标注 ✅ 并保持字段一致
