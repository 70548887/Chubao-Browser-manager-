# å‰ç«¯é›†æˆæŒ‡å—ï¼šè®¾å¤‡æŒ‡çº¹ç”Ÿæˆç³»ç»Ÿ

## ğŸ“‹ é›†æˆçŠ¶æ€

### âŒ å½“å‰çŠ¶æ€ï¼šæœªé›†æˆ

- å‰ç«¯ä»£ç ä¸­æœªæ‰¾åˆ°ä»»ä½•æŒ‡çº¹APIè°ƒç”¨
- `Step3FingerprintSettings.vue` ä½¿ç”¨ç¡¬ç¼–ç æ•°ç»„éšæœºç”Ÿæˆ
- ç¼ºå°‘ä¸åç«¯æŒ‡çº¹ç”Ÿæˆå™¨çš„é›†æˆ

### âœ… éœ€è¦é›†æˆçš„API

åç«¯å·²æä¾› **3ä¸ª Tauri Commands**ï¼š

1. `generate_random_fingerprint(profileId)` - ç”ŸæˆéšæœºæŒ‡çº¹
2. `get_template_list()` - è·å–è®¾å¤‡æ¨¡æ¿åˆ—è¡¨
3. `validate_fingerprint(config)` - æ ¡éªŒæŒ‡çº¹ä¸€è‡´æ€§

---

## ğŸ¯ é›†æˆæ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šè‡ªåŠ¨ç”Ÿæˆï¼ˆæ¨èï¼‰â­

**æè¿°**: åˆ›å»ºProfileæ—¶è‡ªåŠ¨è°ƒç”¨åç«¯ç”ŸæˆæŒ‡çº¹

**ä¼˜ç‚¹**: 
- ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œä½“éªŒæµç•…
- ç¡®ä¿æŒ‡çº¹çœŸå®æ€§ï¼ˆåŸºäºSteam 2024æ•°æ®ï¼‰
- è‡ªåŠ¨ä¸€è‡´æ€§æ£€æŸ¥

**æµç¨‹**:
```
ç”¨æˆ·å¡«å†™åŸºæœ¬ä¿¡æ¯ â†’ ç‚¹å‡»åˆ›å»º 
â†’ å‰ç«¯è°ƒç”¨ generate_random_fingerprint 
â†’ è·å–å®Œæ•´æŒ‡çº¹é…ç½® 
â†’ æäº¤ç»™ create_profile
```

---

### æ–¹æ¡ˆ2ï¼šæ‰‹åŠ¨é€‰æ‹©æ¨¡æ¿

**æè¿°**: ç”¨æˆ·å¯é¢„è§ˆå¹¶é€‰æ‹©è®¾å¤‡æ¨¡æ¿

**ä¼˜ç‚¹**:
- ç”¨æˆ·å¯æ§
- å¯é¢„è§ˆè®¾å¤‡ä¿¡æ¯
- é€‚åˆé«˜çº§ç”¨æˆ·

**æµç¨‹**:
```
ç”¨æˆ·ç‚¹å‡»"é€‰æ‹©æ¨¡æ¿" 
â†’ è°ƒç”¨ get_template_list 
â†’ æ˜¾ç¤ºæ¨¡æ¿åˆ—è¡¨ï¼ˆWindows 10ä¸­ç«¯ã€MacOSç­‰ï¼‰
â†’ ç”¨æˆ·é€‰æ‹© 
â†’ è°ƒç”¨ generate_random_fingerprint 
â†’ é¢„è§ˆå¹¶ç¡®è®¤
```

---

## ğŸ’» ä»£ç å®ç°

### 1. åˆ›å»ºæŒ‡çº¹APIæœåŠ¡æ–‡ä»¶

**æ–‡ä»¶**: `src/api/fingerprintApi.ts`

```typescript
import { invoke } from '@tauri-apps/api/core'

/**
 * è®¾å¤‡æ¨¡æ¿ä¿¡æ¯
 */
export interface TemplateInfo {
  id: string
  description: string
  weight: number
  os_name: string
  os_version: string
  cpu_vendor: string
  gpu_vendor: string
}

/**
 * æŒ‡çº¹é…ç½®
 */
export interface FingerprintConfig {
  schema: string
  schema_version: number
  navigator: {
    user_agent: string
    language: string
    languages: string[]
    hardware_concurrency: number
    device_memory: number
    platform: string
  }
  screen: {
    width: number
    height: number
    color_depth: number
    pixel_depth: number
  }
  webgl: {
    vendor: string
    renderer: string
    vendor_unmasked: string
    renderer_unmasked: string
  }
  canvas: {
    rgb_noise: number[]
    coord_offset: [number, number]
  }
  audio: {
    noise_factor: number
  }
  timezone: {
    id: string
    offset_minutes: number
  }
  // ... å…¶ä»–å­—æ®µ
}

/**
 * æ ¡éªŒç»“æœ
 */
export interface ValidationResult {
  valid: boolean
  errors: Array<{
    code: string
    message: string
    severity: 'Error' | 'Warning' | 'Info'
    field: string
  }>
  warnings: Array<{
    code: string
    message: string
    severity: 'Error' | 'Warning' | 'Info'
    field: string
  }>
}

/**
 * ç”ŸæˆéšæœºæŒ‡çº¹
 */
export async function generateRandomFingerprint(profileId: string): Promise<FingerprintConfig> {
  return invoke('generate_random_fingerprint', { profileId })
}

/**
 * è·å–è®¾å¤‡æ¨¡æ¿åˆ—è¡¨
 */
export async function getTemplateList(): Promise<TemplateInfo[]> {
  return invoke('get_template_list')
}

/**
 * æ ¡éªŒæŒ‡çº¹é…ç½®
 */
export async function validateFingerprint(config: FingerprintConfig): Promise<ValidationResult> {
  return invoke('validate_fingerprint', { config })
}
```

---

### 2. ä¿®æ”¹åˆ›å»ºçª—å£å¯¹è¯æ¡†

**æ–‡ä»¶**: `src/features/dashboard/components/CreateWindowDialog.vue`

**ä¿®æ”¹ä½ç½®**ï¼šæäº¤è¡¨å•æ—¶

```typescript
import { generateRandomFingerprint, validateFingerprint } from '@/api/fingerprintApi'
import { ElMessage, ElNotification } from 'element-plus'

// åœ¨æäº¤å‡½æ•°ä¸­
async function handleSubmit() {
  try {
    // 1. ç”Ÿæˆå”¯ä¸€ID
    const profileId = crypto.randomUUID()
    
    // 2. ç”ŸæˆæŒ‡çº¹é…ç½®
    ElMessage.info('æ­£åœ¨ç”Ÿæˆè®¾å¤‡æŒ‡çº¹...')
    const fingerprint = await generateRandomFingerprint(profileId)
    
    // 3. æ ¡éªŒæŒ‡çº¹ï¼ˆå¯é€‰ï¼‰
    const validation = await validateFingerprint(fingerprint)
    
    if (!validation.valid) {
      ElNotification.error({
        title: 'æŒ‡çº¹é…ç½®é”™è¯¯',
        message: validation.errors[0]?.message || 'å­˜åœ¨é…ç½®é”™è¯¯',
        duration: 5000
      })
      return
    }
    
    // 4. æ˜¾ç¤ºè­¦å‘Šï¼ˆå¦‚æœæœ‰ï¼‰
    if (validation.warnings.length > 0) {
      console.warn('æŒ‡çº¹è­¦å‘Š:', validation.warnings)
    }
    
    // 5. åˆ›å»ºProfile
    const profileData = {
      name: formData.name,
      group: formData.group,
      proxy: formData.proxy,
      fingerprint: fingerprint,  // â­ ä¼ å…¥ç”Ÿæˆçš„æŒ‡çº¹
      // ... å…¶ä»–å­—æ®µ
    }
    
    await invoke('create_profile', { data: profileData })
    
    ElMessage.success('åˆ›å»ºæˆåŠŸï¼')
    dialogVisible.value = false
    
  } catch (error) {
    console.error('åˆ›å»ºå¤±è´¥:', error)
    ElMessage.error(`åˆ›å»ºå¤±è´¥: ${error}`)
  }
}
```

---

### 3. æ·»åŠ æ¨¡æ¿é€‰æ‹©å™¨ï¼ˆå¯é€‰ï¼‰

**æ–‡ä»¶**: `src/features/dashboard/components/create-window/Step3FingerprintSettings.vue`

**åœ¨é¡¶éƒ¨æ·»åŠ æ¨¡æ¿é€‰æ‹©**:

```vue
<template>
  <div class="step-content">
    <!-- ========== è®¾å¤‡æ¨¡æ¿é€‰æ‹©å™¨ ========== -->
    <div class="template-selector" v-if="showTemplateSelector">
      <h3 class="section-title">
        è®¾å¤‡æ¨¡æ¿é€‰æ‹©
        <button class="btn-random" @click="randomTemplate">
          <span class="material-symbols-outlined">casino</span>
          éšæœºç”Ÿæˆ
        </button>
      </h3>
      
      <div class="template-list">
        <div 
          v-for="template in templates" 
          :key="template.id"
          class="template-card"
          :class="{ active: selectedTemplateId === template.id }"
          @click="selectTemplate(template.id)"
        >
          <div class="template-header">
            <h4>{{ template.description }}</h4>
            <span class="template-weight">{{ (template.weight * 100).toFixed(0) }}%</span>
          </div>
          <div class="template-specs">
            <span class="spec-item">{{ template.os_name }} {{ template.os_version }}</span>
            <span class="spec-item">{{ template.cpu_vendor }}</span>
            <span class="spec-item">{{ template.gpu_vendor }}</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- åŸæœ‰çš„æŒ‡çº¹è®¾ç½®ç•Œé¢ -->
    <div class="form-section">
      <!-- ... ä¿ç•™ç°æœ‰UI -->
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { getTemplateList, generateRandomFingerprint } from '@/api/fingerprintApi'
import type { TemplateInfo, FingerprintConfig } from '@/api/fingerprintApi'

const model = defineModel<any>({ required: true })
const templates = ref<TemplateInfo[]>([])
const selectedTemplateId = ref<string>('')
const showTemplateSelector = ref(true)

// åŠ è½½æ¨¡æ¿åˆ—è¡¨
onMounted(async () => {
  try {
    templates.value = await getTemplateList()
  } catch (error) {
    console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', error)
  }
})

// é€‰æ‹©æ¨¡æ¿å¹¶ç”ŸæˆæŒ‡çº¹
async function selectTemplate(templateId: string) {
  selectedTemplateId.value = templateId
  
  try {
    // ä½¿ç”¨ä¸´æ—¶IDç”ŸæˆæŒ‡çº¹ï¼ˆåç»­åˆ›å»ºæ—¶ä¼šç”¨çœŸæ­£çš„IDï¼‰
    const fingerprint = await generateRandomFingerprint('preview-' + Date.now())
    
    // å°†ç”Ÿæˆçš„æŒ‡çº¹å¡«å……åˆ°è¡¨å•
    model.value.userAgent = fingerprint.navigator.user_agent
    model.value.hardwareConcurrency = fingerprint.navigator.hardware_concurrency
    model.value.deviceMemory = fingerprint.navigator.device_memory
    model.value.screenWidth = fingerprint.screen.width
    model.value.screenHeight = fingerprint.screen.height
    model.value.webglVendor = fingerprint.webgl.vendor
    model.value.webglRenderer = fingerprint.webgl.renderer
    // ... å…¶ä»–å­—æ®µ
    
  } catch (error) {
    console.error('ç”ŸæˆæŒ‡çº¹å¤±è´¥:', error)
  }
}

// éšæœºç”Ÿæˆ
async function randomTemplate() {
  const randomIndex = Math.floor(Math.random() * templates.value.length)
  await selectTemplate(templates.value[randomIndex].id)
}
</script>

<style scoped lang="scss">
.template-selector {
  margin-bottom: 24px;
  padding: 20px;
  background: #f8fafc;
  border-radius: 12px;
  
  .dark & {
    background: rgba(30, 41, 59, 0.3);
  }
}

.btn-random {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  margin-left: 12px;
  font-size: 13px;
  font-weight: 500;
  color: #2563eb;
  background: white;
  border: 1px solid #2563eb;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  
  &:hover {
    background: #2563eb;
    color: white;
  }
  
  .material-symbols-outlined {
    font-size: 16px;
  }
}

.template-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 12px;
  margin-top: 12px;
}

.template-card {
  padding: 16px;
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  
  .dark & {
    background: var(--color-bg-elevated);
    border-color: var(--color-border-dark);
  }
  
  &:hover {
    border-color: #2563eb;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
  }
  
  &.active {
    border-color: #2563eb;
    background: rgba(37, 99, 235, 0.05);
    
    .template-weight {
      background: #2563eb;
      color: white;
    }
  }
}

.template-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  
  h4 {
    font-size: 14px;
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 0;
  }
}

.template-weight {
  display: inline-block;
  padding: 3px 8px;
  font-size: 11px;
  font-weight: 600;
  background: #f1f5f9;
  color: var(--color-text-tertiary);
  border-radius: 4px;
}

.template-specs {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.spec-item {
  font-size: 12px;
  color: var(--color-text-secondary);
  
  &:before {
    content: 'â€¢';
    margin-right: 8px;
    color: #2563eb;
  }
}
</style>
```

---

### 4. æ˜¾ç¤ºæ ¡éªŒè­¦å‘Šï¼ˆå¯é€‰ï¼‰

```vue
<!-- åœ¨è¡¨å•åº•éƒ¨æ·»åŠ è­¦å‘Šæç¤º -->
<div v-if="validationWarnings.length > 0" class="validation-warnings">
  <div class="warning-header">
    <span class="material-symbols-outlined">warning</span>
    é…ç½®è­¦å‘Š
  </div>
  <ul class="warning-list">
    <li v-for="(warning, index) in validationWarnings" :key="index">
      <strong>{{ warning.code }}</strong>: {{ warning.message }}
    </li>
  </ul>
</div>

<script setup lang="ts">
const validationWarnings = ref([])

// åœ¨ç”ŸæˆæŒ‡çº¹åæ ¡éªŒ
async function generateAndValidate() {
  const fingerprint = await generateRandomFingerprint(profileId)
  const result = await validateFingerprint(fingerprint)
  validationWarnings.value = result.warnings
}
</script>

<style scoped>
.validation-warnings {
  margin-top: 16px;
  padding: 16px;
  background: #fef3c7;
  border: 1px solid #fbbf24;
  border-radius: 8px;
}

.warning-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 600;
  color: #92400e;
  margin-bottom: 8px;
  
  .material-symbols-outlined {
    color: #f59e0b;
  }
}

.warning-list {
  margin: 0;
  padding-left: 20px;
  font-size: 13px;
  color: #92400e;
  
  li {
    margin-bottom: 4px;
  }
}
</style>
```

---

## ğŸ“ é›†æˆæ­¥éª¤

### Step 1: åˆ›å»ºAPIæ–‡ä»¶
```bash
# åœ¨å‰ç«¯é¡¹ç›®ä¸­åˆ›å»º
touch src/api/fingerprintApi.ts
```

å¤åˆ¶ä¸Šé¢çš„APIä»£ç åˆ°æ–‡ä»¶ä¸­

### Step 2: å®‰è£…ç±»å‹å®šä¹‰ï¼ˆå¦‚æœéœ€è¦ï¼‰
```bash
npm install --save-dev @tauri-apps/api
```

### Step 3: ä¿®æ”¹åˆ›å»ºçª—å£é€»è¾‘

æ‰¾åˆ°åˆ›å»ºProfileçš„å‡½æ•°ï¼ˆå¯èƒ½åœ¨ `CreateWindowDialog.vue` æˆ– `DashboardView.vue`ï¼‰ï¼Œæ·»åŠ æŒ‡çº¹ç”Ÿæˆé€»è¾‘

### Step 4: æµ‹è¯•é›†æˆ

```typescript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•
import { generateRandomFingerprint } from '@/api/fingerprintApi'

const fp = await generateRandomFingerprint('test-123')
console.log(fp)
```

### Step 5: éªŒè¯é…ç½®æ–‡ä»¶ç”Ÿæˆ

1. åˆ›å»ºä¸€ä¸ªProfile
2. å¯åŠ¨æµè§ˆå™¨
3. æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼š`D:\DeepChrome\profiles\{uuid}\bm_fingerprint.json`
4. ç¡®è®¤æ–‡ä»¶å†…å®¹æ­£ç¡®

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Profile ID çš„ä¸€è‡´æ€§

**é‡è¦**ï¼šç¡®ä¿ç”ŸæˆæŒ‡çº¹æ—¶ä½¿ç”¨çš„ `profileId` ä¸æœ€ç»ˆåˆ›å»ºçš„Profile IDä¸€è‡´

```typescript
// âŒ é”™è¯¯åšæ³•
const fingerprint = await generateRandomFingerprint('temp-id')
const profile = await createProfile({ name: '...', fingerprint })
// Profileå®é™…ä½¿ç”¨çš„IDå¯èƒ½ä¸åŒ

// âœ… æ­£ç¡®åšæ³•
const profileId = crypto.randomUUID()
const fingerprint = await generateRandomFingerprint(profileId)
const profile = await createProfile({ id: profileId, fingerprint })
```

### 2. é”™è¯¯å¤„ç†

```typescript
try {
  const fingerprint = await generateRandomFingerprint(profileId)
} catch (error) {
  // æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨æˆ–å…¶ä»–é”™è¯¯
  console.error('ç”ŸæˆæŒ‡çº¹å¤±è´¥:', error)
  ElMessage.error('æŒ‡çº¹ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®æ–‡ä»¶')
  // å¯ä»¥ä½¿ç”¨é»˜è®¤æŒ‡çº¹æˆ–æç¤ºç”¨æˆ·
}
```

### 3. å…¼å®¹æ—§æ•°æ®

å¦‚æœæ•°æ®åº“ä¸­å·²æœ‰Profileï¼Œå¯èƒ½æ²¡æœ‰å®Œæ•´çš„æŒ‡çº¹é…ç½®ï¼š

```typescript
// å¯åŠ¨æ—¶æ£€æŸ¥å¹¶è¡¥å…¨æŒ‡çº¹
async function ensureFingerprint(profile) {
  if (!profile.fingerprint || !profile.fingerprint.schema) {
    console.log('è¡¥å…¨æŒ‡çº¹é…ç½®')
    const fingerprint = await generateRandomFingerprint(profile.id)
    await updateProfile(profile.id, { fingerprint })
  }
}
```

---

## ğŸ¯ æ¨èé›†æˆæ–¹å¼

### æœ€ç®€æ–¹æ¡ˆï¼ˆ15åˆ†é’Ÿï¼‰â­

åªä¿®æ”¹åˆ›å»ºProfileçš„æäº¤å‡½æ•°ï¼Œè‡ªåŠ¨ç”ŸæˆæŒ‡çº¹ï¼š

1. åˆ›å»º `fingerprintApi.ts`
2. åœ¨ `createProfile` è°ƒç”¨å‰ç”ŸæˆæŒ‡çº¹
3. ä¼ é€’ç»™åç«¯
4. å®Œæˆï¼

### å®Œæ•´æ–¹æ¡ˆï¼ˆ1-2å°æ—¶ï¼‰

1. åˆ›å»ºAPIæ–‡ä»¶
2. æ·»åŠ æ¨¡æ¿é€‰æ‹©å™¨UI
3. æ·»åŠ æŒ‡çº¹é¢„è§ˆ
4. æ·»åŠ æ ¡éªŒè­¦å‘Šæç¤º
5. æ·»åŠ "é‡æ–°ç”Ÿæˆ"æŒ‰é’®

---

## ğŸ“¦ å®Œæ•´ç¤ºä¾‹ï¼šæœ€ç®€é›†æˆ

```typescript
// src/features/dashboard/components/CreateWindowDialog.vue

import { generateRandomFingerprint } from '@/api/fingerprintApi'

async function handleSubmit() {
  const profileId = crypto.randomUUID()
  
  // â­ æ·»åŠ è¿™ä¸€è¡Œï¼šç”ŸæˆæŒ‡çº¹
  const fingerprint = await generateRandomFingerprint(profileId)
  
  await invoke('create_profile', {
    data: {
      ...formData,
      fingerprint  // â­ ä¼ å…¥ç”Ÿæˆçš„æŒ‡çº¹
    }
  })
}
```

å°±è¿™ä¹ˆç®€å•ï¼âœ…

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Tauri Command API](https://tauri.app/v1/guides/features/command)
- [è®¾å¤‡æŒ‡çº¹æ¨¡æ¿ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ](./è®¾å¤‡æŒ‡çº¹æ¨¡æ¿ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ.md)
- [åç«¯å®æ–½æ€»ç»“](../brain/.../walkthrough.md)
