# 后端开发计划与步骤（V2）

## 1. 背景与现状（基于代码审计）

当前后端已具备：

- Settings：`kernel_path` / `user_data_dir` 读写与校验
- Profile：CRUD + status 更新
- Browser：启动/停止、启动限流（Semaphore）、基础幂等
- BrowserManager：进程注册、基础事件（`profile:status_changed` / `browser:error`）、后台轮询监控退出并回写 DB
- Window：grid/hide/show（基于 PID 枚举 HWND）

当前主要缺口/未完善点：

- Group：后端 IPC/服务/DB 完全缺失（但 `docs/IPC-接口说明.md` 已声明 `get_groups/create_group/...`）
- Fingerprint：尚未落地“子集 + 透传（受控）”策略；当前 update 会覆盖 fingerprint JSON
- 批量语义：批量启动/停止为顺序执行，失败语义与部分成功处理不明确
- 进程状态机：`Starting/Stopping` 等状态未形成闭环；注销时直接移除记录，难以诊断与对账
- 窗口识别稳定性：缺少主窗口过滤/重试，可能误操作 DevTools 或窗口未就绪
- IPC 文档与实现不一致：IPC 文档中存在 Tag/Proxy/RecycleBin 等命令，但后端当前无对应实现

---

## 2. V2 目标（交付定义）

V2 目标是把 V1“可用”提升为“可交付 + 可联调 + 可扩展”：

- **P0 必须交付**：Group（分组）后端闭环 + Fingerprint 受控 merge + 批量语义明确
- **P1 稳定性增强**：进程状态机/异常回收增强 + 窗口识别稳定性增强 + 事件命名/文档统一
- **P2 可选扩展**：对齐 IPC 文档中 Tag/Proxy/RecycleBin（实现或调整文档范围）

---

## 3. V2 范围边界（避免需求漂移）

- **纳入 V2（In Scope）**：
  - Group：CRUD、`profileCount`、禁止删除非空分组（后端强校验）
  - Profile 指纹：受控“子集 + 透传（merge）”写入策略
  - 批量操作语义：返回结构/失败策略/并发策略/幂等策略
  - 进程/事件/窗口稳定性：补齐可靠性与一致性
  - 数据库迁移：新增 groups 表与必要索引/约束

- **不纳入 V2（Out of Scope，默认延期）**：
  - Tag/Proxy/RecycleBin 体系化能力（除非明确业务必须）

---

## 4. 依赖关口（Gate）

- **Gate-DB**：迁移脚本就绪（新增 groups 表 + 兼容老数据），可从空库初始化，也可从现有 DB 升级
- **Gate-IPC**：以 `docs/IPC-接口说明.md` 为准，V2 涉及命令必须落地；不做的命令必须在文档明确标注“未实现/延期”
- **Gate-FP**：Fingerprint merge 策略与白/黑名单确定并通过单测
- **Gate-Batch**：批量命令失败语义确定（中断/继续/返回明细）并写入文档

---

## 5. Phase 规划（按优先级拆解）

### Phase V2-0：接口范围确认与文档对齐（0.5 天，P0）

**目标：** 让“IPC 文档/前端调用/后端实现”三者一致，避免联调期间反复返工。

**任务：**

1. 明确 V2 范围：是否纳入 Tag/Proxy/RecycleBin
2. 对 `docs/IPC-接口说明.md` 做一次“标记式对齐”：
   - 已实现：标记 ✅
   - V2 将实现：标记 🟡（并写预计完成日期）
   - 延期：标记 ⏸️（并指向 V3 文档）

**验收标准：**

- ✅ V2 范围内的所有命令在后端都有注册点（`lib.rs`）与实现
- ✅ 文档无“已声明但完全无实现”的 P0 命令

---

### Phase V2-1：Group（分组）后端闭环（1-2 天，P0）

**目标：** 支撑前端 Group 管理与“禁止删除非空分组”策略，且后端具备防绕过校验。

**设计决策（建议）：**

- 新增 `groups` 表，字段参考 IPC 文档的 TypeScript 定义（`id/name/sort/permission/createdAt/updatedAt/profileCount`）
- `profiles."group"` 字段建议从“group 名称”演进为“groupId（字符串）”，以匹配 IPC 文档与前端数据模型
  - 兼容策略：迁移时将旧值视为 group 名称，自动创建对应 group 并把 profiles 迁移为 groupId

**任务清单：**

1. 数据库迁移：新增 `groups` 表、索引、默认分组
2. GroupService：CRUD + list 时带 `profileCount`
3. IPC Commands：`get_groups/get_group/create_group/update_group/delete_group`
4. 删除策略：后端强制禁止删除 `profileCount > 0` 的分组（返回可直接展示的错误）
5. Profile 侧配合：创建 Profile/更新 Profile 时校验 groupId 存在；不存在则返回明确错误或自动回退默认分组（需在此 phase 明确策略）

**验收标准：**

- ✅ `get_groups` 返回 `profileCount`
- ✅ 删除非空分组返回明确错误（前端可直接提示）
- ✅ 新建 Profile 选择分组后，可正确写入并在列表聚合统计正确

---

### Phase V2-2：Fingerprint（子集 + 透传）受控 merge（1-2 天，P0）

**目标：** 满足已确定策略“子集 + 透传”，同时防止前端/外部输入注入危险字段。

**任务清单：**

1. 定义 Fingerprint schemaVersion（建议：`schemaVersion: number`）
2. 定义白名单字段（允许前端修改的表单子集字段）
3. 定义黑名单字段（永远禁止写入/覆盖的敏感字段，例如：启动参数、路径、调试端口、命令行注入类字段）
4. 实现 merge 规则：
   - existing JSON 与 patch JSON 合并
   - 白名单字段：从 patch 覆盖 existing
   - 非白名单字段：保持 existing（实现“透传不丢”）
   - 黑名单字段：若 patch 包含则拒绝（返回明确错误）
5. 单元测试：
   - 白名单字段可更新
   - 非白名单字段不会被 patch 覆盖
   - 黑名单字段直接拒绝

**验收标准：**

- ✅ “透传字段不丢”：existing 中的未知字段仍被保留
- ✅ “受控字段可改”：表单子集字段更新生效
- ✅ “危险字段不可注入”：黑名单写入会失败

---

### Phase V2-3：批量操作语义明确 + 并发策略（0.5-1 天，P0）

**目标：** 前端能稳定展示批量进度与失败原因，且后端具备并发限制与幂等语义。

**建议输出规范：**

- 批量命令返回“逐项结果”而不是单一 `void`，例如：
  - `[{ profileId, ok: boolean, error?: string }]`
- 批量启动并发：使用 `BrowserManager` 的 semaphore 控制并发数（已有），但批量层要支持并发调度
- 失败语义：明确三种之一并写入 IPC 文档：
  - A) 任一失败立即中断
  - B) 继续执行并收集错误（推荐）
  - C) 分批执行（窗口数大时更稳）

**验收标准：**

- ✅ 批量接口返回逐项结果（可被前端直接展示）
- ✅ “部分成功”场景可解释、可重试

---

### Phase V2-4：进程状态机与一致性增强（0.5-1 天，P1）

**目标：** 降低“状态漂移”，提升诊断能力。

**任务清单：**

1. 状态机闭环：`Starting -> Running -> Stopping -> Stopped/Error`
2. 退出对账：后台监控不仅 remove，而是先记录退出时间/退出原因（如果可获得）
3. DB 对账：启动/停止/异常退出的 DB 更新路径统一
4. 事件一致性：状态事件与 DB 状态更新顺序明确（避免 UI 先变后回滚）

**验收标准：**

- ✅ 启动失败/异常退出/手动关闭都能回写 DB 与发事件
- ✅ 进程表不会“无记录但 DB 显示 running”的明显漂移

---

### Phase V2-5：窗口识别稳定性增强（1-2 天，P1）

**目标：** 10+ 窗口的 grid/hide/show 稳定可靠。

**任务清单：**

1. 主窗口过滤：按标题/类名/窗口样式排除 DevTools/扩展窗口
2. 重试机制：启动后窗口未就绪时重试查找（例如最多 3 次，每次 1 秒）
3. 多显示器：明确 grid 计算策略（主屏/全屏/按工作区）

**验收标准：**

- ✅ 10 个窗口 hide/show/grid 稳定
- ✅ 不会误操作 DevTools
- ✅ 窗口晚到也能通过重试找到

---

### Phase V2-6：IPC 文档中的 Tag/Proxy/RecycleBin（2-5 天，P2，可选）

**现状：** `docs/IPC-接口说明.md` 已定义 Tag/Proxy/RecycleBin 命令与类型，但后端当前无任何实现与模块。

**两种策略（二选一，需在 V2-0 决策）：**

- 策略 A（推荐默认）：**从 V2 计划中移出**，并在 IPC 文档对应章节标注“延期至 V3”（避免虚假接口）
- 策略 B：**纳入 V2 并落地最小可用闭环**
  - migrations：新增 tags/proxies/recycle_bin 表
  - services + IPC commands + 基础校验

**验收标准：**

- ✅ 选择 A：文档清晰标注延期，前端不会引用
- ✅ 选择 B：后端实现与文档完全一致，且至少可 CRUD

---

## 6. 工期汇总（建议）

| Phase | 内容 | 优先级 | 预计时间 |
|---|---|---:|---:|
| V2-0 | 范围确认 + 文档对齐 | P0 | 0.5 天 |
| V2-1 | Group 后端闭环 | P0 | 1-2 天 |
| V2-2 | Fingerprint 受控 merge | P0 | 1-2 天 |
| V2-3 | 批量语义 + 并发结果 | P0 | 0.5-1 天 |
| V2-4 | 进程状态机一致性增强 | P1 | 0.5-1 天 |
| V2-5 | 窗口识别稳定性增强 | P1 | 1-2 天 |
| V2-6 | Tag/Proxy/RecycleBin（可选） | P2 | 2-5 天 |
|  | **P0 合计（建议优先交付）** |  | **3-5.5 天** |
|  | **P0+P1 合计（稳定可交付）** |  | **5-9.5 天** |

---

## 7. 最终验收清单（V2 Done Definition）

- [ ] Group：CRUD + `profileCount` + 禁止删除非空（后端强校验）
- [ ] Fingerprint：子集 + 透传 merge 完成，黑名单防注入，单测通过
- [ ] 批量操作：返回逐项结果，失败语义明确，前端可展示
- [ ] 进程与 DB 状态：异常退出可对账、状态漂移显著减少
- [ ] Window：10 窗口群控稳定（主窗口过滤 + 重试）
- [ ] `docs/IPC-接口说明.md`：V2 范围内命令与实现一致

---

## 8. 风险与回滚策略

- **Group 字段演进风险**：如果将 `profiles."group"` 从名称迁移为 groupId，需要迁移脚本与兼容逻辑；建议在迁移前备份 DB，并提供“默认分组兜底”。
- **Fingerprint merge 风险**：白/黑名单定义不当会导致前端字段无法保存或出现安全漏洞；建议先冻结一版白/黑名单并单测覆盖。
- **批量并发风险**：并发过高会导致系统卡顿；必须通过 semaphore 控制并发，且默认并发数可配置。
