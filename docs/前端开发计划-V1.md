# 前端开发计划 - V1（本地 RPC/命令式 / Tauri IPC）

本文档面向前端工程师，用于明确 V1 版本的开发范围、工程规范、任务拆分、验收标准与每日自测流程。

- 接口形态：本地 RPC / 命令式（Tauri IPC `invoke`）
- IPC 权威来源：`src-tauri/src/lib.rs`
- IPC 接口文档：`docs/IPC-接口说明.md`

---

## 1. V1 目标与交付边界

### 1.1 目标（Definition of Done）
V1 达到“启动器可用”，包含：

- Settings：可配置并持久化 `kernel_path` / `user_data_dir` / `default_proxy`
- Profile：可创建/编辑/删除、列表展示与筛选
- Browser：可启动/停止单个与批量
- Window（Windows）：宫格排列、隐藏全部、显示全部
- Group（分组）：支持 CRUD；删除策略为“禁止删除（必须先清空该分组下的 Profile）”
- Fingerprint：采用“子集 + 透传（受控）”策略（见第 4 节）

### 1.2 非目标（V1 不做）
- 不做对外 HTTP API（不是 RESTful）
- 不做复杂的跨设备同步与多端协同
- 不做完整“源码级指纹对抗”交付，只做可控配置与策略落地

---

## 2. 工程规范（强制）

### 2.1 API 与 IPC 规范
- 页面/组件 **禁止直接** 调用 `invoke`，只能通过 `src/api/*.ts`
- 业务侧只允许从 `@/api`（`src/api/index.ts`）导入
- IPC 命令名与参数名大小写必须严格一致（Tauri 参数映射规则）
- IPC 新增/修改：必须同步更新 `docs/IPC-接口说明.md`

### 2.2 类型体系（DTO vs Model）
- DTO（后端协议）只允许存在于 API 层内部（`src/api/*`）
- Store/组件仅使用 `src/types/*` 中的前端 Model
- `created_at/updated_at`（RFC3339）必须在 API 层转换为 `createdAt/updatedAt:number`

### 2.3 Store（Pinia）职责边界
- Store 负责：状态（list/current/loading/error）与业务流程（fetch/CRUD/start/stop/batch）
- API 负责：IPC 调用、DTO→Model 映射、错误包装
- 组件负责：交互与展示，不直接拼装协议字段

### 2.4 错误展示规范
- API 统一 `throw new Error('可展示中文信息: 原始错误')`
- UI 统一展示 `error.message`（toast/dialog），不得吞错
- 对关键错误（如 kernel_path 未设置）要提供“去设置”引导

---

## 3. 任务拆分（P0/P1/P2）

> 说明：工时仅为参考，实际以联调复杂度为准。

### P0（1-2 天）：工程收敛（阻塞交付）

#### P0-1 API 单一入口治理（函数式 API）
- 目标：全项目只保留函数式 API 用法，消灭对象式旧入口
- 交付物：
  - 全局无 `ProfileApi/BrowserApi` 旧引用
  - `src/api/index.ts` 为唯一导出出口
- 验收：
  - 全局搜索 `ProfileApi`/`BrowserApi` = 0
  - 全局搜索 `invoke(`（src 下）仅出现在 `src/api/`
- 预计工时：0.5 天

#### P0-2 DTO→Model 映射归口（Profile/Group/Fingerprint）
- 目标：所有 DTO 字段转换在 API 层完成，store/组件不做兼容逻辑
- 交付物：
  - `profileApi.ts` 的 `dtoToProfile()` 覆盖 fingerprint/proxy/time 等
  - `groupApi.ts` 的 `dtoToGroup()` 覆盖 time 与 profileCount
- 验收：
  - `vue-tsc --noEmit` 通过（或至少不出现 any 连锁）
- 预计工时：0.5-1 天

#### P0-3 错误规范与统一展示
- 目标：所有失败都可理解、可定位、可引导
- 交付物：
  - API 层统一错误包装
  - UI 层统一错误提示与关键引导（kernel_path 未设置）
- 验收：
  - kernel_path 为空时：提示明确 + 引导进入 Settings
- 预计工时：0.5 天

---

### P1（2-4 天）：功能闭环稳定（含 Group）

#### P1-1 Group 接入：数据源 + 列表筛选 + 编辑选择
- 目标：Dashboard 支持按 group 筛选；Profile Editor 支持选择 group
- 交付物：
  - GroupStore（建议新增）：`groups[]/currentGroup/loading/error`
  - Dashboard：group 下拉筛选（全部/默认/具体分组）
  - Profile Editor：group 选择器（来自 GroupStore）
- 验收：
  - 新建分组后可立即用于创建 profile
  - Dashboard 切换分组筛选正确
- 预计工时：1-1.5 天
- 依赖：后端 group IPC 完整可用

#### P1-2 Group 管理：CRUD + 删除限制（禁止删除必须先清空）
- 目标：分组可管理；删除分组必须确保该组 profileCount=0
- 交付物：
  - 分组管理弹窗/页面：列表 + 新增 + 改名 + 删除
  - 删除策略：
    - `profileCount > 0`：禁用删除按钮或点击提示“请先清空该分组下的环境”
    - `profileCount == 0`：允许删除
- 验收：
  - 有 profile 的分组无法删除（UI 层阻止 + 提示）
  - 空分组可删除
- 预计工时：1-2 天
- 依赖：`GroupDto.profile_count` 必须可靠；建议后端也做一致性校验

#### P1-3 指纹策略落地（前端职责）：子集 + 透传（受控）
- 目标：前端只编辑白名单字段；不会把未知字段覆盖为空
- 交付物：
  - 提交时只提交 fingerprintPatch（白名单字段集合）
  - UI 对未知字段不提供编辑（可展示“存在扩展配置（不可编辑）”）
- 验收：
  - 修改 timezone 后保存：不会丢失历史 fingerprint 扩展字段（透传依赖后端 merge）
- 预计工时：0.5-1 天
- 依赖：后端 fingerprint merge（existing + patch）且白名单过滤/黑名单剔除

---

### P2（1-2 天）：体验与可用性增强（非阻塞，建议做）

#### P2-1 批量操作反馈与失败可见
- 目标：批量启动/停止/删除要明确结果（成功/失败数量与失败项）
- 验收：
  - 10 个批量操作中 2 个失败：能看到失败项（name/id）与原因
- 预计工时：0.5-1 天
- 依赖：后端批量接口失败策略（中断/继续）明确

#### P2-2 首次使用引导（kernel_path 未设置）
- 目标：启动时报错不“硬崩”，引导去 Settings
- 验收：
  - kernel_path 为空：提示 + “去设置”按钮跳转
- 预计工时：0.5 天

---

## 4. Fingerprint（指纹）策略：子集 + 透传（受控）

### 4.1 核心原则
- 子集：前端只允许编辑并提交白名单字段
- 透传：更新时保留已有但前端不编辑的字段（不丢失）
- 受控：后端必须做二次校验（白名单过滤 + 黑名单剔除），防绕过

### 4.2 V1 白名单字段（允许写入）
- 基础字段：`platform`, `browser`, `hardwareConcurrency`, `deviceMemory`, `screenResolution`, `timezone`, `language`
- 噪声开关：`canvasNoise`, `webglNoise`, `audioNoise`
- 高级字段（可选）：`webrtc`, `webrtcPublicIp`, `webrtcLocalIp`, `webglVendor`, `webglRenderer`, `webgpu`, `canvas`, `audioContext`, `doNotTrack`, `clientRects`, `mediaDevices`, `fonts`, `resolution`

### 4.3 黑名单字段（禁止写入）
- 命令/参数类：`launchArgs`, `args`, `cmdline`
- 路径/加载类：`extensionPath`, `loadExtension`, `binaryPath`, `pluginPath`
- 调试/远程控制类：`remoteDebuggingPort`, `cdpPort`
- 脚本注入类：`injectScript`, `preload`
- 任何以 `path/Path` 结尾的未知字段默认按风险处理

### 4.4 后端合并策略（透传不丢的关键）
- `fingerprint = merge(existing, patch)`
  - patch 只包含白名单字段
  - existing 的其它字段保持不变

### 4.5 验收用例（前后端联调必须跑）
- FP-1 透传不丢：只改 timezone，历史扩展字段仍存在
- FP-2 黑名单拒绝：提交含 `launchArgs` 应被拒绝或清理并告警
- FP-3 类型校验：错误类型输入（如 string）应被拒绝或降级（策略明确）

---

## 5. Group（分组）功能策略

### 5.1 删除策略（V1 已确认）
- 禁止删除非空分组：必须先清空该分组下的 Profile

### 5.2 UI/交互要求
- `profileCount > 0`：删除按钮禁用或点击提示
- `profileCount == 0`：允许删除

---

## 6. 每日自测（提交前必须跑，10-15 分钟）

### 用例 A：Settings 闭环
- 设置 `kernel_path/user_data_dir` 保存
- 重启应用后回显正确

### 用例 B：Group 闭环
- 新建分组
- 创建 profile 选择该分组
- Dashboard 筛选该分组正确

### 用例 C：Group 删除限制
- 分组内存在 profile → 删除被阻止并提示
- 清空后 → 可删除

### 用例 D：Fingerprint 子集 + 透传
- 仅修改白名单字段（如 timezone）保存
- 历史 fingerprint 扩展字段不丢

### 用例 E：启动/停止
- 单个启动成功 → 停止成功
- 批量启动/停止至少 5 个，不假死，有反馈

---

## 7. 单人排期建议（建议 5 个工作日）

> 说明：这是“单人开发”的推荐排期，优先保证主链路可交付。若你希望 3 天内完成，则需削减 P2 并压缩 Group 管理 UI。

### Day 1（工程收敛）
- 目标：完成 P0-1、P0-2 的主干工作
- 交付：
  - API 单一入口治理（全局无旧 API 引用）
  - Profile/Group 的 DTO→Model 映射归口（时间字段转换完成）
- 当日验收：
  - 全局搜索 `invoke(`（src 下）仅出现在 `src/api/`
  - 全局搜索 `ProfileApi/BrowserApi` 为 0

### Day 2（错误规范 + Group 基础接入）
- 目标：完成 P0-3 + P1-1（Group 过滤与选择）的最小闭环
- 交付：
  - 统一错误展示（尤其 kernel_path 未设置引导）
  - GroupStore 雏形 + Dashboard 分组筛选 + ProfileEditor 分组选择
- 当日验收：
  - kernel_path 为空时，启动按钮提示明确并可跳转 Settings
  - 新建分组后可用于创建 Profile

### Day 3（Group 管理 CRUD + 删除限制）
- 目标：完成 P1-2
- 交付：
  - 分组管理界面（列表/新增/改名/删除）
  - 删除限制：`profileCount > 0` 必须阻止删除并提示
- 当日验收：
  - 非空分组删除按钮禁用或点击提示“请先清空该分组下的环境”
  - 空分组可删除

### Day 4（Fingerprint：子集 + 透传落地）
- 目标：完成 P1-3
- 交付：
  - ProfileEditor 提交时仅提交 fingerprintPatch（白名单字段）
  - UI 不支持编辑未知字段（可提示“存在扩展配置（不可编辑）”）
- 当日验收：
  - 修改 timezone 保存后，历史 fingerprint 扩展字段不丢（需后端 merge 支持）

### Day 5（稳定性与体验收尾）
- 目标：完成 P2-1/P2-2（可按时间选择性完成）+ 全量回归
- 交付：
  - 批量操作失败反馈（成功/失败数量与失败项）
  - 首次使用引导（kernel_path 未设置时引导）
  - 冒烟用例 A-E 全绿
- 当日验收：
  - 批量启动/停止 10 个 Profile 不假死，失败可见

---

## 8. 依赖关口清单（联调 Gate）

> 说明：这些关口决定前端能否按计划交付。建议前后端每日联调时按 Gate 检查。

### Gate G0：IPC 命令一致性（必须）
- 要求：`src-tauri/src/lib.rs`、`docs/IPC-接口说明.md`、`src/api/*.ts` 三者保持一致
- 前端检查点：
  - 命令名一致
  - 参数名大小写一致（尤其 `profileId/profileIds`）

### Gate G1：Group IPC 可用性（必须）
- 要求：后端提供并稳定以下命令（命令名/参数名以 IPC 文档为准）：
  - `get_groups`
  - `get_group`
  - `create_group`
  - `update_group`
  - `delete_group`
- 关键字段：`GroupDto.profile_count` 必须可靠（用于“禁止删除非空分组”的前端拦截）
- 若未就绪的前端降级：隐藏删除按钮或全部禁用删除，并提示“后端能力未就绪”

### Gate G2：Fingerprint 合并策略（必须）
- 要求：后端实现 `existing + patch` merge，且对白名单字段放行、黑名单字段拒绝/剔除
- 前端依赖点：前端只提交 fingerprintPatch；透传验证需要后端 merge 才成立
- 若未就绪的前端降级：先仅允许创建时写入基础字段；编辑指纹入口暂时置灰

### Gate G3：批量接口失败语义（必须明确）
- 需要后端确认：批量操作遇到失败时是“失败即中断”还是“继续执行并收集错误”
- 前端实现依赖：
  - 若“失败即中断”：提示“已执行到第 N 个失败停止”，并展示失败原因
  - 若“收集错误继续”：展示成功/失败列表

### Gate G4：状态一致性事件（建议，非 V1 阻塞）
- 目标：后端通过 Tauri event 推送 profile 状态变化，前端订阅后更新 store，避免 UI 漂移
- 若未就绪：V1 先采用前端乐观更新 + 失败回滚；风险为“手动关闭窗口导致状态漂移”
