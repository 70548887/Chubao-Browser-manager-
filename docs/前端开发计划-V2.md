# 前端开发计划 - V2（本地 RPC/命令式 / Tauri IPC）

## 1. 背景与现状（基于代码审计）

审计范围：

- 页面：`src/features/dashboard/*`、`src/features/profile-editor/*`、`src/features/settings/*`、`src/features/groups/*`、`src/features/tags/*`、`src/features/proxy/*`、`src/features/recycle/*`
- Store：`src/stores/profile.store.ts`、`src/stores/groupStore.ts`
- API：`src/api/*`（Profile/Browser/Settings/Group）
- 事件：`src/services/eventListener.ts`（Tauri 事件监听）

### 1.1 当前完成度评估（前端侧）

- **总体完成度（前端侧）**：约 **60%-70%（偏 65%）**
- **主链路可用（可联调）**：
  - Dashboard 环境列表（筛选/排序/分页/批量操作入口）
  - ProfileDrawer（创建/编辑）
  - Settings（kernel_path/user_data_dir/default_proxy 读写）
  - 事件监听已接入（`profile:status_changed`）
- **明显未完成/依赖后端 Gate 的部分**：
  - **Group 真正联调未完成**：虽已有 Group API + GroupStore + GroupManagement 页面，但后端 Group IPC 当前缺失，导致 Store 会回退 mock 数据；同时 BasicInfoForm 的 group 选择仍为输入框而非真实下拉
  - **Fingerprint 策略仅做了“子集过滤”，未完成“子集 + 透传（patch）”**：ProfileDrawer 保存前会将 fingerprint 过滤为白名单字段并直接提交，会导致 existing 中的未知字段丢失（透传依赖后端 merge，但前端也需要提交 patch 而非覆盖）
  - **批量操作反馈不足**：后端批量接口返回 `void`，前端只能“假设成功”；无法展示逐项失败原因（依赖后端 V2-批量语义）
  - **事件处理不完整**：当前只监听 `profile:status_changed`，未监听 `browser:error`（后端已发）
  - **tags/proxy/recycle 页面为 mock UI**：目前未接 API/Store，属于“UI 壳/演示”，是否纳入 V2 需明确

### 1.2 现状与 V1 文档对照（结论）

- **V1 计划中的 P0（API 治理/DTO→Model/错误规范）**：大体已落地（invoke 基本集中在 `src/api/*`，DTO→Model 转换已实现）
- **V1 计划中的 Group/Fingerprint/批量反馈**：实现“有雏形”，但仍受后端 Gate 阻塞，且 Fingerprint 的“透传”前端侧也未按 patch 提交

---

## 2. V2 目标（交付定义）

V2 的目标是让前端从“页面可看/主链路可跑”升级为“真实数据联调可交付”。

- **P0 必须交付（跟随后端 V2 的 Gate）**：
  - Group：从 mock 切到真实后端数据（CRUD + 删除限制）
  - Fingerprint：前端提交 fingerprintPatch（白名单字段），不再覆盖全量 fingerprint
  - 批量：UI 能展示逐项结果（成功/失败/原因）
  - 事件：补齐 `browser:error` 展示，并与状态事件协同

- **P1 稳定性增强**：
  - Group/Profile 的一致性刷新策略（避免每次 update 都全量 fetch 的卡顿）
  - 统一消息提示与错误可定位
  - Settings 的文件/目录选择（Tauri v2 dialog）落地或明确延期

- **P2 可选扩展**：
  - tags/proxy/recycle 若确为 V2 范围：补齐 API/Store/真实联调；否则应明确从导航中隐藏或标记“未实现/敬请期待”

---

## 3. 依赖关口（前后端联调 Gate）

- **Gate-BE-Group**：后端实现 `get_groups/get_group/create_group/update_group/delete_group` 且返回 `profileCount`（或 `profile_count`→映射一致）
- **Gate-BE-FP**：后端实现 Fingerprint merge（existing + patch）与黑名单防注入
- **Gate-BE-Batch**：后端批量接口返回逐项结果（至少包含 profileId + ok + error）或明确“中断/继续”策略
- **Gate-BE-Events**：事件命名稳定（已存在 `profile:status_changed`、`browser:error`），并明确 payload

---

## 4. Phase 规划（按优先级）

### Phase FE-V2-0：范围确认与页面“真/假”标注（0.5 天，P0）

**目标：** 明确 V2 是否纳入 tags/proxy/recycle，避免前端做完 UI 但永远无后端。

**任务：**

1. 确认 V2 交付范围：
   - A) 仅交付 Profile/Settings/Group/Fingerprint/Batch/Events
   - B) 同时交付 tags/proxy/recycle
2. 若选择 A：
   - 在 UI 中对 tags/proxy/recycle 显示“未开放/预览”
   - 或从导航移除入口（取决于产品策略）

**验收：**

- ✅ V2 范围内的页面都可真实联调
- ✅ 非范围页面不会误导用户（明确标识）

---

### Phase FE-V2-1：Group 真联调（1-2 天，P0）

**目标：** GroupStore 不再依赖 mock 回退，GroupManagement 页面与 Profile 创建/编辑真正接入分组。

**任务：**

1. GroupStore：
   - 去掉“失败直接回退 mock 并继续写本地”的交互路径（可保留 dev fallback，但必须显式提示且不作为默认路径）
   - CRUD 全部走 API，并在失败时只提示错误，不修改本地真数据
2. BasicInfoForm：
   - `group` 从输入框改为 `el-select`（数据源来自 GroupStore.groupOptions）
   - 选择默认分组策略明确（默认 `default` 或后端返回的默认组）
3. Dashboard：
   - 增加 group 筛选下拉（依赖后端 Group 列表）
4. 删除限制：
   - UI 层：`profileCount>0` 禁用删除并提示
   - 后端会强校验：前端接住错误并提示

**验收：**

- ✅ 后端 Group 就绪后：页面不再出现 mock 数据
- ✅ 创建/编辑 Profile 可选择真实分组
- ✅ 分组删除限制行为正确

---

### Phase FE-V2-2：Fingerprint 策略（子集 + 透传 patch）落地（0.5-1 天，P0）

**现状问题：** 目前 ProfileDrawer 保存前会 `filterFingerprintWhitelist` 并直接提交，导致 unknown 字段丢失（不满足“透传不丢”）。

**目标：** 前端只提交 fingerprintPatch（白名单字段），让后端做 merge。

**任务：**

1. ProfileDrawer 保存时：
   - 仍做黑名单检测与白名单过滤
   - **不再把 fingerprint 覆盖为过滤后的全量**
   - 改为：
     - 创建：允许提交完整白名单指纹（作为初始 fingerprint）
     - 编辑：提交 fingerprintPatch（白名单字段）并保留 existing 的其余字段（由后端 merge）
2. 配合后端 schemaVersion：前端提交时带 `schemaVersion`（若后端要求）

**验收：**

- ✅ 修改 timezone 保存后，历史未知字段不丢（需要后端 merge + 前端 patch 提交）
- ✅ 检测到黑名单字段时，前端提示并过滤/阻止提交（策略明确）

---

### Phase FE-V2-3：批量操作反馈（0.5-1.5 天，P0）

**目标：** 批量启动/停止/删除能够展示：成功数、失败数、失败项原因。

**任务：**

1. 后端批量接口返回逐项结果后：
   - Dashboard 批量操作 Toast/弹窗展示汇总 + 失败列表
2. 幂等策略：
   - “已在运行/已停止”应当算成功（避免用户误以为失败）

**验收：**

- ✅ 10 个批量操作中 2 个失败：能看到失败项与原因

---

### Phase FE-V2-4：事件与状态一致性（0.5 天，P1）

**目标：** 事件驱动状态更新更完整，错误可见。

**任务：**

1. `eventListener.ts`：
   - 新增监听 `browser:error`，弹 toast，并将对应 profile 标记为 `error`（或触发刷新）
2. 状态冲突策略：
   - 若本地 optimistic 更新与事件冲突，以事件为准

**验收：**

- ✅ 启动失败会立即弹出明确错误
- ✅ UI 状态最终与后端一致

---

### Phase FE-V2-5：Settings 文件/目录选择（0.5-1 天，P2 或 P1）

**现状：** SettingsView 的文件对话框被注释，当前只能手动输入路径。

**任务：**

- 若 Tauri v2 dialog 可用：启用选择文件/目录
- 若不可用：在 V2 文档中明确延期，并提供输入校验/示例与错误提示增强

---

## 5. 工期汇总（建议）

| Phase | 内容 | 优先级 | 预计时间 |
|---|---|---:|---:|
| FE-V2-0 | 范围确认 + 假页面标注/隐藏策略 | P0 | 0.5 天 |
| FE-V2-1 | Group 真联调（CRUD/删除限制/下拉选择/筛选） | P0 | 1-2 天 |
| FE-V2-2 | Fingerprint patch 提交（子集 + 透传） | P0 | 0.5-1 天 |
| FE-V2-3 | 批量反馈（逐项结果展示） | P0 | 0.5-1.5 天 |
| FE-V2-4 | 事件补齐（browser:error） | P1 | 0.5 天 |
| FE-V2-5 | Settings 文件/目录选择（可选） | P2/P1 | 0.5-1 天 |
|  | **P0 合计** |  | **2.5-5 天** |

---

## 6. 最终验收清单（V2 Done Definition）

- [ ] Group：不使用 mock 回退作为默认路径；真实 CRUD 可联调；删除限制正确
- [ ] ProfileEditor：group 为真实选择器；Fingerprint 以 patch 提交（不丢 unknown 字段）
- [ ] 批量操作：能展示逐项结果与失败原因
- [ ] 事件：监听 `profile:status_changed` + `browser:error`，并稳定更新 UI 状态
- [ ] 非范围页面（tags/proxy/recycle）：明确“未开放/延期”或真实接入（两者必须选其一）
