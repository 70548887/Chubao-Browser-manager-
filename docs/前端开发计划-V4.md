# 前端开发计划 - V4（需要解决的问题清单 / Gate 驱动）

> V4 目标：把 V1（目标/DoD）、V2（代码审计现状）、V3（真实阻塞与修正口径）汇总为一份“接下来必须解决的问题清单”。
> 
> 适用场景：排期、联调看板、对外同步口径（避免误报“已完成可交付”）。

---

## 1. 现状一句话结论

- **前端现状完成度**：约 **60%-70%（偏 65%）**。
- **当前可跑**：Settings / Profile CRUD / 启停主链路 / `profile:status_changed` 事件。
- **当前不可交付闭环的关键原因**：**Group / Fingerprint 透传 / 批量逐项结果 / 错误事件消费 / scope（tags/proxy/recycle）** 未闭环。

---

## 2. P0 必须解决（阻塞交付）

### P0-1（Gate-BE-Group）：Group 真联调闭环

- **问题**：后端缺 Group IPC/服务，前端 `groupStore` 会 fallback mock，导致 Group 相关验收不可执行。
- **责任归属**：后端（主）+ 前端（配合去 mock/改 UI）。
- **解除条件**：
  - 后端实现并注册：`get_groups/get_group/create_group/update_group/delete_group`
  - 返回包含 `profile_count`（或 `profileCount`）并与前端映射一致
  - 删除策略：后端强校验“禁止删除非空分组”
- **前端需要做的改动点（解锁后立刻做）**：
  - 去掉默认 mock fallback（至少在默认路径不写本地假数据）
  - `BasicInfoForm`：`group` 由输入框改为下拉选择器（数据源 GroupStore）
  - Dashboard：分组筛选下拉（依赖后端 groups）
- **验收用例**：
  - 创建分组 → 创建 Profile 选择该分组 → Dashboard 按分组筛选正确
  - 分组内存在 Profile 时：删除分组失败（前端提示 + 后端强校验）

### P0-2（Gate-FP）：Fingerprint “子集 + 透传（受控）”落地

- **问题**：当前前端保存时对白名单过滤后覆盖提交，导致 unknown 字段丢失；后端无 merge。
- **责任归属**：前端（patch 提交）+ 后端（merge + 黑名单防注入）。
- **解除条件**：
  - 前端：编辑时提交 `fingerprintPatch`（白名单字段）而非覆盖全量
  - 后端：existing + patch merge；黑名单字段拒绝/剔除并返回可展示错误
- **验收用例**：
  - existing fingerprint 含未知字段 `ext.foo=1`，前端只改 timezone 保存后，`ext.foo` 仍存在
  - 提交含黑名单字段（如 `launchArgs`）应被拒绝或清理并告警

### P0-3（Gate-BE-Batch）：批量操作逐项结果 + 失败语义

- **问题**：批量接口返回 `void`，前端只能“显示数量”无法展示逐项失败原因；失败语义未定义。
- **责任归属**：后端（返回结构与语义）+ 前端（展示）。
- **解除条件**：
  - 后端明确失败语义：继续执行并收集错误（推荐）或失败即中断（需写入文档）
  - 后端返回逐项结果：`[{ profileId, ok, error? }]`
  - 前端在 Dashboard 对批量结果做汇总展示 + 失败列表
- **验收用例**：
  - 批量启动 10 个，其中 2 个失败：前端能看到失败项与原因

---

## 3. P1 必须补齐（稳定可用/可定位）

### P1-1（Gate-Events）：补齐 `browser:error` 事件消费

- **问题**：后端已发 `browser:error`，前端未监听，导致启动失败/运行异常不可见。
- **责任归属**：前端。
- **解除条件**：
  - `eventListener.ts` 监听 `browser:error`，toast 提示错误
  - 与 `profile:status_changed` 协同：状态冲突以事件为准（策略明确）
- **验收用例**：
  - 触发后端 `browser:error`：前端立即提示，并能定位到 profile

### P1-2：数据一致性与刷新策略

- **问题**：当前多处以“假设成功/全量刷新/乐观更新”为主，后端事件与本地状态可能冲突。
- **责任归属**：前端。
- **解除条件**：
  - 明确：何时全量 `fetchProfiles()`，何时局部更新
  - 批量/事件回调后状态最终一致
- **验收用例**：
  - 批量启动后状态最终与后端一致，不出现长时间“卡在 running/stopped”

### P1-3：错误信息可定位（统一 toast + 可复制）

- **问题**：当前错误多为 `error.message` toast，但缺少“可复制/可追踪 ID/建议动作”。
- **责任归属**：前端（主）+ 后端（返回更结构化的错误）。
- **解除条件**：
  - 关键错误（kernel_path 无效、权限不足、启动失败）提示包含建议动作

---

## 4. P2 范围与交付边界（必须做决策，否则持续误导）

### P2-1（Gate-Doc-Scope）：tags/proxy/recycle 的范围确认与 UI 处理

- **问题**：页面目前是 mock UI；后端也无对应 IPC；但 UI 中存在入口易误导。
- **责任归属**：产品/架构决策 + 前端落地。
- **解除条件（二选一）**：
  - A）延期：UI 标注“未开放/预览”或隐藏入口；文档标注延期
  - B）纳入：补齐 API/Store/后端 IPC + 数据表，做真实联调

### P2-2：Settings 文件/目录选择（Tauri v2 dialog）

- **问题**：当前只能手动输入（对普通用户不友好）。
- **责任归属**：前端。
- **解除条件**：
  - 若可用：接入 dialog 选择 exe/目录
  - 若不可用：明确延期 + 提供更强校验/示例路径

---

## 5. 推荐排期（单人前端，按“等后端 Gate”现实排序）

> 注意：P0 的 1/2/3 依赖后端 Gate，前端可先做“可并行准备项”。

- **Day 0.5**：Scope 决策（tags/proxy/recycle 处理方式定稿）
- **Day 1**：前端准备（Group 下拉/筛选 UI、去 mock fallback 的改造预备、批量结果 UI 组件骨架）
- **Day 2-3**：后端 Gate-BE-Group 解锁后，完成 Group 真联调闭环
- **Day 3-4**：Fingerprint patch 提交（前端）+ 后端 merge 联调验收
- **Day 4-5**：批量逐项结果联调 + `browser:error` 事件消费 + 一致性策略收尾

---

## 6. V4 Done Definition（对外可宣称“可交付”的最低标准）

- [ ] Group 真联调可用：无默认 mock fallback；CRUD + 删除非空限制可验收
- [ ] Fingerprint 透传不丢：patch 提交 + 后端 merge + 黑名单防注入可验收
- [ ] 批量可解释：逐项结果 + 部分失败可展示
- [ ] 错误可见：监听 `browser:error` 并提示；状态最终一致
- [ ] Scope 清晰：tags/proxy/recycle 明确延期或真实接入（二选一）
