# 触宝指纹浏览器 - 应用发布流程

## 📋 目录

- [1. 版本发布前准备](#1-版本发布前准备)
- [2. 打包构建](#2-打包构建)
- [3. 上传到服务器](#3-上传到服务器)
- [4. 配置更新 API](#4-配置更新-api)
- [5. 测试更新流程](#5-测试更新流程)

---

## 1. 版本发布前准备

### 1.1 更新版本号

修改以下文件中的版本号（保持一致）：

```json
// package.json
{
  "version": "0.3.0"
}

// src-tauri/tauri.conf.json
{
  "version": "0.3.0"
}

// src-tauri/Cargo.toml
[package]
version = "0.3.0"
```

### 1.2 更新变更日志

编辑更新说明，用于在更新弹窗中显示：

```
新功能：
- 新增 XXX 功能
- 优化 YYY 性能

修复问题：
- 修复 ZZZ 崩溃问题
```

### 1.3 清理临时文件

```powershell
# 清理编译缓存
Remove-Item -Recurse -Force dist, src-tauri/target -ErrorAction SilentlyContinue
```

---

## 2. 打包构建

### 2.1 执行打包脚本

使用自动打包脚本：

```powershell
# 方式 1: 使用 tauri.conf.json 中的版本号
npm run release

# 方式 2: 指定版本号
npm run release:version 0.3.0
```

或手动执行：

```powershell
cd scripts
.\build-release.ps1
# 或指定版本
.\build-release.ps1 -Version "0.3.0"
```

### 2.2 打包产物

打包完成后，在 `release/v0.3.0/` 目录下会生成：

```
release/v0.3.0/
├── browser-manager_0.3.0_x64.msi          # MSI 安装包
├── browser-manager_0.3.0_x64_setup.exe    # NSIS 安装包
├── kernel_0.3.0_windows_x64.zip           # 浏览器内核压缩包
└── update-info.json                        # 更新信息（包含文件哈希）
```

### 2.3 检查 update-info.json

```json
{
  "launcher": {
    "version": "0.3.0",
    "platform": "windows",
    "arch": "x86_64",
    "release_date": "2026-02-06",
    "files": [
      {
        "name": "browser-manager_0.3.0_x64_setup.exe",
        "size": 15728640,
        "sha256": "abcd1234...",
        "download_url": "https://cdn.yourdomain.com/releases/v0.3.0/browser-manager_0.3.0_x64_setup.exe"
      }
    ]
  },
  "kernel": {
    "version": "0.3.0",
    "platform": "windows",
    "arch": "x86_64",
    "release_date": "2026-02-06",
    "files": [
      {
        "name": "kernel_0.3.0_windows_x64.zip",
        "size": 104857600,
        "sha256": "efgh5678...",
        "download_url": "https://cdn.yourdomain.com/releases/v0.3.0/kernel_0.3.0_windows_x64.zip"
      }
    ]
  }
}
```

**重要**：修改 `download_url` 为你的实际 CDN 或服务器地址。

---

## 3. 上传到服务器

### 3.1 上传文件到 CDN/服务器

将打包文件上传到你的文件服务器或 CDN：

```bash
# 示例：使用 scp 上传到服务器
scp release/v0.3.0/* user@your-server.com:/var/www/cdn/releases/v0.3.0/

# 或使用 OSS 工具（阿里云 OSS、腾讯云 COS 等）
ossutil cp -r release/v0.3.0/ oss://your-bucket/releases/v0.3.0/
```

### 3.2 验证文件可访问

确保以下 URL 可访问：

```
https://cdn.yourdomain.com/releases/v0.3.0/browser-manager_0.3.0_x64_setup.exe
https://cdn.yourdomain.com/releases/v0.3.0/kernel_0.3.0_windows_x64.zip
```

### 3.3 配置下载源（推荐多源）

为国内用户优化，建议配置多个下载源：

1. **自建 CDN**（优先级最高）
2. **国内镜像加速**（备用）
3. **GitHub Releases**（国际备用）

---

## 4. 配置更新 API

### 4.1 更新后端数据库

在后端数据库中插入新版本信息：

```sql
-- 启动器更新
INSERT INTO launcher_versions (
    version, 
    platform, 
    arch, 
    release_date, 
    release_notes, 
    mandatory, 
    file_size, 
    file_hash,
    download_sources
) VALUES (
    '0.3.0',
    'windows',
    'x86_64',
    '2026-02-06',
    '新增 XXX 功能\n优化 YYY 性能\n修复 ZZZ 问题',
    false,
    15728640,
    'abcd1234...',
    '[
        {"id": 1, "name": "自建CDN（推荐）", "url": "https://cdn.yourdomain.com/releases/v0.3.0/browser-manager_0.3.0_x64_setup.exe", "priority": 1, "region": "CN"},
        {"id": 2, "name": "镜像加速", "url": "https://mirror.yourdomain.com/releases/v0.3.0/browser-manager_0.3.0_x64_setup.exe", "priority": 2, "region": "CN"},
        {"id": 3, "name": "GitHub Releases", "url": "https://github.com/yourname/browser-manager/releases/download/v0.3.0/browser-manager_0.3.0_x64_setup.exe", "priority": 3, "region": "GLOBAL"}
    ]'
);

-- 内核更新
INSERT INTO kernel_versions (
    version, 
    platform, 
    arch, 
    release_date, 
    release_notes, 
    compatible_launcher_version,
    file_size, 
    file_hash,
    download_sources
) VALUES (
    '0.3.0',
    'windows',
    'x86_64',
    '2026-02-06',
    '内核升级到 Chromium 118\n优化指纹防护能力',
    '>=0.2.0',
    104857600,
    'efgh5678...',
    '[
        {"id": 1, "name": "自建CDN（推荐）", "url": "https://cdn.yourdomain.com/releases/v0.3.0/kernel_0.3.0_windows_x64.zip", "priority": 1, "region": "CN"}
    ]'
);
```

### 4.2 验证 API 接口

测试更新检测 API：

```bash
# 启动器更新检测
curl "http://localhost:8080/api/v1/updates/launcher?version=0.2.0&platform=windows&arch=x86_64"

# 内核更新检测
curl "http://localhost:8080/api/v1/updates/kernel?version=0.2.0&platform=windows&arch=x86_64&launcher_version=0.3.0"
```

预期响应：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "has_update": true,
    "version": "0.3.0",
    "current_version": "0.2.0",
    "latest_version": "0.3.0",
    "release_date": "2026-02-06",
    "release_notes": "新增 XXX 功能\n优化 YYY 性能",
    "mandatory": false,
    "file_size": 15728640,
    "file_hash": "abcd1234...",
    "downloads": [
      {
        "id": 1,
        "name": "自建CDN（推荐）",
        "url": "https://cdn.yourdomain.com/releases/v0.3.0/browser-manager_0.3.0_x64_setup.exe",
        "priority": 1,
        "region": "CN"
      }
    ]
  }
}
```

---

## 5. 测试更新流程

### 5.1 本地测试

1. **修改更新服务器地址**（如果需要）：
   ```
   设置 → 基础设置 → 更新服务器地址
   修改为：http://localhost:8080 或你的测试服务器
   ```

2. **触发更新检测**：
   - 应用启动 2 秒后自动检查
   - 或在设置页面点击"检查更新"

3. **验证更新按钮显示**：
   - 标题栏右上角应显示火箭图标 🚀

4. **测试下载流程**：
   - 点击火箭图标
   - 查看更新详情
   - 选择下载源下载
   - 验证 SHA256 校验

5. **测试安装流程**：
   - 启动器：下载完成后提示安装并重启
   - 内核：下载解压后自动替换

### 5.2 生产环境发布

1. **灰度发布**（可选）：
   - 先发布给少量测试用户
   - 确认无问题后全量发布

2. **监控更新率**：
   - 监控后端 API 的更新检测请求量
   - 监控下载成功率

3. **回滚机制**：
   - 保留旧版本安装包
   - 如有问题可快速回滚版本

---

## 📝 附录

### 常见问题

**Q: 打包失败怎么办？**
A: 检查 Node.js 和 Rust 环境，确保 `npm install` 完整执行。

**Q: 如何生成代码签名？**
A: 购买代码签名证书，在 `tauri.conf.json` 中配置 `certificateThumbprint`。

**Q: 如何支持 32 位系统？**
A: 修改打包脚本，添加 `--target i686-pc-windows-msvc` 编译 32 位版本。

**Q: 更新检测失败？**
A: 检查防火墙、更新服务器地址、后端 API 是否正常。

---

## 🔗 相关文档

- [应用自动更新功能设计方案](./应用自动更新功能设计方案.md)
- [Tauri 官方文档](https://tauri.app/v2/guides/building/)
