# 前端开发计划 - V3（真实联调阻塞清单 + 修正口径 + 修正验收用例）

> 重要：本文件用于“对齐真实现状”，不修改 `docs/2026-01-28-开发进度与测试总结.md` 原文。
> 
> V3 的输出目标：
> 
> - 给出当前版本**真实可联调边界**
> - 列出**实际阻塞清单（Gate）**与责任归属（前端/后端/文档）
> - 给出“总结文档中的不准确结论”的**修正口径**（供对外同步/对内排期）
> - 给出与现状一致的**验收/冒烟用例**（尤其 Group/Fingerprint/Batch/Events）

---

## 1. 当前真实完成度（以联调 Gate 为准）

### 1.1 前端真实完成度

- **前端完成度**：约 **60%-70%（偏 65%）**
- **说明**：主链路页面基本具备，但多个关键点仍处于“UI/调用已写，后端 Gate 未闭环，或前端策略未按 patch 方式落地”的状态。

### 1.2 当前真实可联调功能（能跑通的部分）

- **Settings（真实联调）**：
  - `get_all_settings` / `get_setting_value` / `set_setting_value`
  - Dashboard 启动前校验 `kernel_path` 并引导跳转 Settings
- **Profile（真实联调）**：
  - list/get/create/update/delete/batch_delete
- **Browser 启停（真实联调）**：
  - `launch_browser` / `stop_browser` / `batch_launch_browsers` / `batch_stop_browsers`
  - 但批量失败语义与逐项结果不可见（见 Gate-Batch）
- **事件（部分联调）**：
  - 已接入 `profile:status_changed`（前端监听并更新 store）

### 1.3 当前不可联调/不可验收的功能（由于缺实现或假数据）

- **Group（后端缺失）**：后端未实现 `get_groups/create_group/...`，前端 `groupStore` 会 fallback mock
- **Fingerprint（透传不丢未闭环）**：前端保存时会把 fingerprint 过滤后覆盖提交；后端未实现 merge
- **tags/proxy/recycle**：前端页面为 mock UI（未接 API/Store）；后端亦无对应命令实现

---

## 2. 实际联调阻塞清单（Gate）

> 每个 Gate 都包含：现状、影响、责任归属、解除条件、验收方式。

### Gate-BE-Group：Group 后端 IPC/服务缺失（P0）

- **现状**：前端已存在 `groupApi.ts`（调用 `get_groups/create_group/...`）、`groupStore.ts`、`GroupManagement.vue`，但后端 `src-tauri/src/lib.rs` 未注册相关命令，`src-tauri/src/modules/` 也无 group 模块。
- **影响**：
  - Group 功能只能走 mock fallback，无法做真实 CRUD 联调
  - 分组删除限制、Profile 选择分组、Dashboard 按分组筛选等验收无法成立
- **归属**：后端（实现命令/DB/service）+ IPC 文档对齐
- **解除条件**：
  - 后端实现并注册：`get_groups/get_group/create_group/update_group/delete_group`
  - 返回结构与前端映射一致：至少 `id/name/sort/profile_count(or profileCount)/permission/created_at/updated_at`
  - 删除策略：禁止删除非空分组（后端强校验，错误可直出）
- **验收方式**：
  - 前端去掉/关闭 mock fallback 后仍可正常使用 Group 管理页
  - 新建分组→创建 Profile 选择该分组→Dashboard 筛选该分组正确

### Gate-FP：Fingerprint “子集 + 透传（受控）”未闭环（P0）

- **现状**：
  - 前端具备白/黑名单与过滤逻辑（`src/config/fingerprint.config.ts`）
  - 但保存时仍会 `filterFingerprintWhitelist()` 后**直接覆盖提交**（不是 fingerprintPatch）
  - 后端目前 update_profile 会直接覆盖 fingerprint JSON，未实现 merge
- **影响**：
  - “透传不丢”验收失败：existing 中未知字段会被覆盖丢失
  - 安全策略只做到前端过滤，后端缺少二次校验
- **归属**：前端（patch 提交策略）+ 后端（merge + 黑名单防注入）
- **解除条件**：
  - 前端：编辑时提交 fingerprintPatch（白名单字段）而不是覆盖全量
  - 后端：实现 existing + patch merge，黑名单字段拒绝或剔除
- **验收方式**：
  - 用例：existing fingerprint 中含未知字段 `ext.foo=1`，前端只改 timezone 保存后，`ext.foo` 仍保留

### Gate-Batch：批量接口缺乏逐项结果与失败语义（P0）

- **现状**：后端批量命令返回 `void`；前端只能提示“成功数量”，无法知道逐项失败原因。
- **影响**：
  - 无法做“部分成功”的产品级反馈
  - 无法指导用户重试失败项
- **归属**：后端（接口返回结构）+ 前端（UI 展示）
- **解除条件**：
  - 后端批量命令返回逐项结果：`[{ profileId, ok, error? }]`（或等价结构）
  - 明确失败语义：继续执行并收集错误（推荐）或失败即中断（需写入文档）
- **验收方式**：
  - 模拟 10 个启动中 2 个失败：前端能展示失败项与原因

### Gate-Events：事件只接入一半（P1）

- **现状**：前端已监听 `profile:status_changed`，未监听 `browser:error`（后端已发）。
- **影响**：
  - 启动失败/运行异常不会通过事件实时呈现
  - UI 可能只看到状态变动，缺少错误原因
- **归属**：前端（监听 + 展示）
- **解除条件**：
  - 前端补齐监听 `browser:error` 并 toast 提示/联动状态
- **验收方式**：
  - 后端 emit error 时，前端立即提示且对应 profile 状态合理更新

### Gate-Doc-Scope：IPC 文档声明超出实现范围（P1/P2）

- **现状**：`docs/IPC-接口说明.md` 中包含 Tag/Proxy/RecycleBin 的命令与类型定义，但当前后端无任何实现；前端 tags/proxy/recycle 页面也为 mock UI。
- **影响**：
  - 对外/对内沟通会误判“功能已存在”
  - 测试用例与验收项会写成不可执行
- **归属**：产品/架构（范围确认）+ 文档维护
- **解除条件**（二选一）：
  - A）明确延期：文档标注“未实现/延期至 V3/V4”，前端入口标注“未开放/预览”
  - B）纳入实现：后端补齐相应命令与数据表，前端补齐 API/Store 真联调

---

## 3. 对《开发进度与测试总结》不准确结论的“修正口径”（不改原文）

> 下面内容用于你在对外同步/团队沟通时避免误导。

### 3.1 进度口径修正

- 原文：整体进度 90%，FE-0~FE-2 100%，可交付
- **修正口径**：
  - **前端约 65%**：主链路页面可用，但 Group/Fingerprint/Batch/Events 存在 Gate 未闭环
  - **后端约 75%**：Profile/Settings/Browser/Window 可用，但 Group 与 Fingerprint merge 缺失
  - **整体约 70%（按 Gate 完成度）**：处于“可运行待联调”，不应宣称“功能已全部完成”

### 3.2 Phase FE-3 口径修正

- 原文：FE-3 0%，依赖后端事件
- **修正口径**：
  - FE-3 **部分完成**：已接入 `profile:status_changed`
  - FE-3 **未完成项**：补齐 `browser:error`，并明确事件与本地 optimistic 更新冲突策略

### 3.3 Fingerprint 策略口径修正

- 原文：子集 + 透传已实现
- **修正口径**：
  - 当前实现为“子集过滤”，但**透传不丢未闭环**（编辑保存会覆盖 unknown 字段）
  - 需要前端改为 fingerprintPatch 提交 + 后端 merge 才能宣称“透传”完成

### 3.4 Group 策略口径修正

- 原文：Group 完成
- **修正口径**：
  - 前端 UI/Store/API 已具备，但后端 Group IPC 缺失 → 真实联调不可执行
  - 目前只能作为“前端结构已就绪，等待后端 Gate”

### 3.5 批量操作口径修正

- 原文：批量操作完成
- **修正口径**：
  - 命令可调用，但缺少逐项结果与失败语义 → 产品级验收未完成

---

## 4. 修正后的验收/冒烟用例（与现状一致）

> 说明：用例分两类：
> 
> - A 类：当前版本即可执行（不依赖缺失 Gate）
> - B 类：需 Gate 解锁后才能执行（否则会误判为“bug”）

### A 类：当前即可执行（建议先跑）

#### A-1 Settings 闭环

1. 进入 Settings
2. 手动输入并保存 `kernel_path`
3. 重启应用
4. 验证设置回显正确

**预期**：设置持久化成功；保存失败有明确提示。

#### A-2 Profile CRUD

1. 创建 Profile（最少字段 name）
2. 列表出现
3. 编辑 name/remark
4. 删除 Profile

**预期**：CRUD 正常，列表与 DB 一致。

#### A-3 启动/停止（单个）

1. `kernel_path` 为有效 exe
2. 启动某 Profile
3. 浏览器打开，状态变 running
4. 停止

**预期**：启停成功，状态变更可通过事件或本地更新呈现。

#### A-4 事件：profile:status_changed（已接入）

1. 启动 Profile
2. 观察 UI 状态是否收到事件更新（控制台可见 log）

**预期**：事件触发后 store 状态更新。

### B 类：需 Gate 解锁后执行（当前不执行）

#### B-1 Group 真联调（需 Gate-BE-Group）

1. 进入 GroupManagement
2. 创建分组
3. 新建 Profile 选择该分组（下拉选择器）
4. Dashboard 筛选该分组
5. 删除非空分组应失败

**预期**：全链路真实联调可跑通，删除策略后端也强校验。

#### B-2 Fingerprint 透传不丢（需 Gate-FP）

1. 构造 existing fingerprint 包含未知字段 `ext.foo=1`
2. 前端只改 timezone
3. 保存
4. 从后端读取 fingerprint，验证 `ext.foo` 仍存在

**预期**：未知字段透传保留。

#### B-3 批量逐项结果（需 Gate-Batch）

1. 选择 10 个 Profile 批量启动
2. 强制让其中 2 个失败（例如 kernelPath 无效/权限问题/资源不足）
3. UI 展示失败项与原因

**预期**：逐项结果可见，部分成功可解释。

#### B-4 事件：browser:error（需 Gate-Events 前端补齐监听）

1. 触发后端 emit `browser:error`
2. 前端 toast 提示错误原因，并联动状态

**预期**：错误事件实时可见。

---

## 5. V3 执行顺序建议（单人 3-5 天）

1. **优先解锁 Gate-BE-Group（后端）** → 前端去掉 mock fallback/补齐下拉选择与筛选
2. **并行推进 Gate-FP（前后端共同）** → 前端 patch 提交 + 后端 merge
3. **推进 Gate-Batch（后端先）** → 前端批量结果 UI
4. **补齐 Gate-Events（前端）** → 监听 `browser:error`
5. **Scope 决策（tags/proxy/recycle）** → 明确延期或纳入实现

---

## 6. 交付定义（V3 Done）

- [ ] Gate-BE-Group 解锁：前端不再使用 mock fallback 作为默认路径
- [ ] Gate-FP 解锁：Fingerprint patch + merge，透传不丢可验收
- [ ] Gate-Batch 解锁：批量逐项结果可展示
- [ ] Gate-Events 解锁：`browser:error` 可见
- [ ] IPC 文档范围与实现一致：超范围部分明确标注延期或实现
