name: Release Build

on:
  push:
    tags:
      - 'v*' # 推送 tag 时触发，如 v0.2.0, v0.3.0
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write
  
env:
  RUST_BACKTRACE: 1

jobs:
  build-tauri:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: windows-latest
            rust_target: x86_64-pc-windows-msvc
            arch: x64
          - os: windows-latest
            rust_target: i686-pc-windows-msvc
            arch: x86

    runs-on: ${{ matrix.platform.os }}
    steps:
      - uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.rust_target }}

      - name: Rust 缓存
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: 安装前端依赖
        run: npm ci

      - name: 构建 Tauri 应用 (标准版 - 不含内核)
        run: npm run tauri build -- --target ${{ matrix.platform.rust_target }}

      - name: 获取版本号
        id: get_version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: 收集标准版安装包
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $arch = "${{ matrix.platform.arch }}"
          $bundleDir = "src-tauri/target/${{ matrix.platform.rust_target }}/release/bundle"
          
          # 创建输出目录
          New-Item -ItemType Directory -Force -Path "release-files" | Out-Null
          
          # 复制并重命名 MSI (标准版)
          if (Test-Path "$bundleDir/msi/*.msi") {
            $msi = Get-Item "$bundleDir/msi/*.msi" | Select-Object -First 1
            $newName = "browser-manager_${version}_${arch}.msi"
            Copy-Item $msi.FullName -Destination "release-files/$newName"
            Write-Host "✓ 标准版 MSI: $newName"
          }
          
          # 复制并重命名 NSIS (标准版)
          if (Test-Path "$bundleDir/nsis/*setup.exe") {
            $nsis = Get-Item "$bundleDir/nsis/*setup.exe" | Select-Object -First 1
            $newName = "browser-manager_${version}_${arch}_setup.exe"
            Copy-Item $nsis.FullName -Destination "release-files/$newName"
            Write-Host "✓ 标准版 NSIS: $newName"
          }

      - name: 构建完整版 (含内核压缩包)
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $arch = "${{ matrix.platform.arch }}"
          $kernelZip = "resources/chromium-146-windows-x64.zip"
          $kernelVol1 = "resources/chromium-146-windows-x64.zip.001"
          $kernelVol2 = "resources/chromium-146-windows-x64.zip.002"
          
          # 检查内核压缩包是否存在 (完整或分卷)
          $hasKernel = $false
          if (Test-Path $kernelZip) {
            Write-Host "✓ 找到完整内核压缩包: $kernelZip"
            Copy-Item $kernelZip -Destination "release-files/chromium-146-windows-x64.zip"
            $hasKernel = $true
          } elseif ((Test-Path $kernelVol1) -and (Test-Path $kernelVol2)) {
            Write-Host "✓ 找到分卷内核压缩包"
            Copy-Item $kernelVol1 -Destination "release-files/chromium-146-windows-x64.zip.001"
            Copy-Item $kernelVol2 -Destination "release-files/chromium-146-windows-x64.zip.002"
            $hasKernel = $true
          }
          
          if ($hasKernel) {
            Write-Host "开始构建完整版 (含内嵌内核)..."
            
            # 重新构建 Tauri 应用 (会自动打包内核压缩包)
            npm run tauri build -- --target ${{ matrix.platform.rust_target }}
            
            $bundleDir = "src-tauri/target/${{ matrix.platform.rust_target }}/release/bundle"
            
            # 复制并重命名完整版 MSI
            if (Test-Path "$bundleDir/msi/*.msi") {
              $msi = Get-Item "$bundleDir/msi/*.msi" | Select-Object -First 1
              $newName = "browser-manager_${version}_${arch}_full.msi"
              Copy-Item $msi.FullName -Destination "release-files/$newName"
              Write-Host "✓ 完整版 MSI: $newName"
            }
            
            # 复制并重命名完整版 NSIS
            if (Test-Path "$bundleDir/nsis/*setup.exe") {
              $nsis = Get-Item "$bundleDir/nsis/*setup.exe" | Select-Object -First 1
              $newName = "browser-manager_${version}_${arch}_full_setup.exe"
              Copy-Item $nsis.FullName -Destination "release-files/$newName"
              Write-Host "✓ 完整版 NSIS: $newName"
            }
            
            echo "HAS_FULL_VERSION=true" >> $env:GITHUB_ENV
          } else {
            Write-Host "⚠ 未找到内核压缩包,跳过完整版构建"
            echo "HAS_FULL_VERSION=false" >> $env:GITHUB_ENV
          }

      - name: 上传到 GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: release-files/*
          body: |
            ## 触宝指纹浏览器 v${{ steps.get_version.outputs.VERSION }}
            
            自动发布的版本，详见更新日志。
            
            ### 📦 安装包说明
            
            **标准版 (推荐 - 体积小)**
            - `browser-manager_*_x64.msi` / `*_x64_setup.exe` - 64位标准版
            - `browser-manager_*_x86.msi` / `*_x86_setup.exe` - 32位标准版
            - 仅包含启动器,不含浏览器内核
            - 安装包大小: ~8 MB
            - 首次使用时需要下载内核 (约 174 MB)
            
            **完整版 (可选 - 开箱即用)**
            - `browser-manager_*_x64_full.msi` / `*_x64_full_setup.exe` - 64位完整版
            - `browser-manager_*_x86_full.msi` / `*_x86_full_setup.exe` - 32位完整版
            - 包含启动器 + 内嵌 Chromium 146 内核
            - 安装包大小: ~180 MB
            - 首次运行时自动解压内核 (约需 30秒-1分钟)
            - 安装后即可使用,无需额外下载
            
            **独立内核包** (可选,手动安装用)
            - `chromium-146-windows-x64.zip` - Chromium 146 浏览器内核 (完整包)
            - `chromium-146-windows-x64.zip.001` + `.zip.002` - 分卷压缩包 (95MB + 75MB)
            - 支持两种形式: 完整ZIP或分卷,应用会自动识别并解压
            - 如需手动安装或升级内核,可下载任一形式
            
            ### 💡 版本选择建议
            - **网络良好**: 推荐下载标准版,体积小,安装快
            - **网络受限**: 推荐下载完整版,一次性安装完成
            - **企业部署**: 推荐完整版,减少网络依赖

