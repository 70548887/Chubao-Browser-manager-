name: Release Build

on:
  push:
    tags:
      - 'v*' # æ¨é€ tag æ—¶è§¦å‘ï¼Œå¦‚ v0.2.0, v0.3.0
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  
env:
  RUST_BACKTRACE: 1

jobs:
  build-tauri:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: windows-latest
            rust_target: x86_64-pc-windows-msvc
            arch: x64
          - os: windows-latest
            rust_target: i686-pc-windows-msvc
            arch: x86

    runs-on: ${{ matrix.platform.os }}
    steps:
      - uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£… Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.rust_target }}

      - name: Rust ç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: npm ci

      - name: æ„å»º Tauri åº”ç”¨
        run: npm run tauri build -- --target ${{ matrix.platform.rust_target }}

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: æ”¶é›†å®‰è£…åŒ…æ–‡ä»¶
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $arch = "${{ matrix.platform.arch }}"
          $bundleDir = "src-tauri/target/${{ matrix.platform.rust_target }}/release/bundle"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          New-Item -ItemType Directory -Force -Path "release-files" | Out-Null
          
          # å¤åˆ¶å¹¶é‡å‘½å MSI (æ ‡å‡†ç‰ˆ - ä¸å«å†…æ ¸)
          if (Test-Path "$bundleDir/msi/*.msi") {
            $msi = Get-Item "$bundleDir/msi/*.msi" | Select-Object -First 1
            $newName = "browser-manager_${version}_${arch}.msi"
            Copy-Item $msi.FullName -Destination "release-files/$newName"
          }
          
          # å¤åˆ¶å¹¶é‡å‘½å NSIS (æ ‡å‡†ç‰ˆ - ä¸å«å†…æ ¸)
          if (Test-Path "$bundleDir/nsis/*setup.exe") {
            $nsis = Get-Item "$bundleDir/nsis/*setup.exe" | Select-Object -First 1
            $newName = "browser-manager_${version}_${arch}_setup.exe"
            Copy-Item $nsis.FullName -Destination "release-files/$newName"
          }
          
          # æ‰“åŒ…ç‹¬ç«‹å†…æ ¸
          $kernelDir = "resources/kernel/win32"
          if (Test-Path $kernelDir) {
            # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„å†…æ ¸æ–‡ä»¶(ä¸åªæ˜¯ .gitkeep)
            $kernelFiles = Get-ChildItem $kernelDir -Exclude ".gitkeep" -ErrorAction SilentlyContinue
            if ($kernelFiles.Count -gt 0) {
              $zipName = "kernel_${version}_windows_${arch}.zip"
              Compress-Archive -Path "$kernelDir/*" -DestinationPath "release-files/$zipName" -Force
              Write-Host "âœ“ å†…æ ¸å·²æ‰“åŒ…: $zipName"
              
              # æ ‡è®°æœ‰å†…æ ¸æ–‡ä»¶
              echo "HAS_KERNEL=true" >> $env:GITHUB_ENV
            } else {
              Write-Host "âš  å†…æ ¸ç›®å½•ä¸ºç©º,è·³è¿‡å†…æ ¸æ‰“åŒ…"
              echo "HAS_KERNEL=false" >> $env:GITHUB_ENV
            }
          }

      - name: æ„å»ºå®Œæ•´ç‰ˆ (ä»…å½“æœ‰å†…æ ¸æ—¶)
        if: env.HAS_KERNEL == 'true'
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $arch = "${{ matrix.platform.arch }}"
          $bundleDir = "src-tauri/target/${{ matrix.platform.rust_target }}/release/bundle"
          
          Write-Host "å¼€å§‹æ„å»ºå®Œæ•´ç‰ˆ(åŒ…å«å†…æ ¸)..."
          
          # é‡æ–°æ„å»º Tauri åº”ç”¨(è¿™æ¬¡åŒ…å«å†…æ ¸)
          npm run tauri build -- --target ${{ matrix.platform.rust_target }}
          
          # å¤åˆ¶å¹¶é‡å‘½åå®Œæ•´ç‰ˆ MSI
          if (Test-Path "$bundleDir/msi/*.msi") {
            $msi = Get-Item "$bundleDir/msi/*.msi" | Select-Object -First 1
            $newName = "browser-manager_${version}_${arch}_full.msi"
            Copy-Item $msi.FullName -Destination "release-files/$newName"
            Write-Host "âœ“ å®Œæ•´ç‰ˆ MSI: $newName"
          }
          
          # å¤åˆ¶å¹¶é‡å‘½åå®Œæ•´ç‰ˆ NSIS
          if (Test-Path "$bundleDir/nsis/*setup.exe") {
            $nsis = Get-Item "$bundleDir/nsis/*setup.exe" | Select-Object -First 1
            $newName = "browser-manager_${version}_${arch}_full_setup.exe"
            Copy-Item $nsis.FullName -Destination "release-files/$newName"
            Write-Host "âœ“ å®Œæ•´ç‰ˆ NSIS: $newName"
          }

      - name: ä¸Šä¼ åˆ° GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: release-files/*
          body: |
            ## è§¦å®æŒ‡çº¹æµè§ˆå™¨ v${{ steps.get_version.outputs.VERSION }}
            
            è‡ªåŠ¨å‘å¸ƒçš„ç‰ˆæœ¬ï¼Œè¯¦è§æ›´æ–°æ—¥å¿—ã€‚
            
            ### ğŸ“¦ å®‰è£…åŒ…è¯´æ˜
            
            **æ ‡å‡†ç‰ˆ (æ¨è)**
            - `browser-manager_*_x64.msi` / `*_x64_setup.exe` - 64ä½å¯åŠ¨å™¨(ä¸å«å†…æ ¸)
            - `browser-manager_*_x86.msi` / `*_x86_setup.exe` - 32ä½å¯åŠ¨å™¨(ä¸å«å†…æ ¸)
            - ä½“ç§¯å°,é¦–æ¬¡ä½¿ç”¨æ—¶ä¼šæç¤ºä¸‹è½½å†…æ ¸
            
            **å®Œæ•´ç‰ˆ (å¯é€‰)**
            - `browser-manager_*_x64_full.msi` / `*_x64_full_setup.exe` - 64ä½å®Œæ•´ç‰ˆ(å«å†…æ ¸)
            - `browser-manager_*_x86_full.msi` / `*_x86_full_setup.exe` - 32ä½å®Œæ•´ç‰ˆ(å«å†…æ ¸)
            - ä½“ç§¯å¤§,å®‰è£…åå³å¯ä½¿ç”¨,æ— éœ€é¢å¤–ä¸‹è½½
            
            **ç‹¬ç«‹å†…æ ¸åŒ…**
            - `kernel_*_windows_*.zip` - æµè§ˆå™¨å†…æ ¸å‹ç¼©åŒ…(æ‰‹åŠ¨å®‰è£…ç”¨)
            
            ### ğŸ’¡ ä½¿ç”¨å»ºè®®
            - **ç½‘ç»œè‰¯å¥½**: æ¨èä¸‹è½½æ ‡å‡†ç‰ˆ,ä½“ç§¯å°,æ›´æ–°å¿«
            - **ç½‘ç»œå—é™**: æ¨èä¸‹è½½å®Œæ•´ç‰ˆ,ä¸€æ¬¡æ€§å®‰è£…å®Œæˆ

