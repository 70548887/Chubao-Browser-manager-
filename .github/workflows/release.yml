name: Release Build

on:
  push:
    tags:
      - 'v*' # 推送 tag 时触发，如 v0.2.0, v0.3.0
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write
  
env:
  RUST_BACKTRACE: 1

jobs:
  build-tauri:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: windows-latest
            rust_target: x86_64-pc-windows-msvc
            arch: x64
          - os: windows-latest
            rust_target: i686-pc-windows-msvc
            arch: x86

    runs-on: ${{ matrix.platform.os }}
    steps:
      - uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.rust_target }}

      - name: Rust 缓存
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: 安装前端依赖
        run: npm ci

      - name: 构建 Tauri 应用
        run: npm run tauri build -- --target ${{ matrix.platform.rust_target }}

      - name: 获取版本号
        id: get_version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: 收集安装包文件
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $arch = "${{ matrix.platform.arch }}"
          $bundleDir = "src-tauri/target/${{ matrix.platform.rust_target }}/release/bundle"
          
          # 创建输出目录
          New-Item -ItemType Directory -Force -Path "release-files" | Out-Null
          
          # 复制并重命名 MSI
          if (Test-Path "$bundleDir/msi/*.msi") {
            $msi = Get-Item "$bundleDir/msi/*.msi" | Select-Object -First 1
            $newName = "browser-manager_${version}_${arch}.msi"
            Copy-Item $msi.FullName -Destination "release-files/$newName"
          }
          
          # 复制并重命名 NSIS
          if (Test-Path "$bundleDir/nsis/*setup.exe") {
            $nsis = Get-Item "$bundleDir/nsis/*setup.exe" | Select-Object -First 1
            $newName = "browser-manager_${version}_${arch}_setup.exe"
            Copy-Item $nsis.FullName -Destination "release-files/$newName"
          }
          
          # 打包内核
          $kernelDir = "resources/kernel/win32"
          if (Test-Path $kernelDir) {
            $zipName = "kernel_${version}_windows_${arch}.zip"
            Compress-Archive -Path "$kernelDir/*" -DestinationPath "release-files/$zipName" -Force
          }

      - name: 上传到 GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: release-files/*
          body: |
            ## 触宝指纹浏览器 v${{ steps.get_version.outputs.VERSION }}
            
            自动发布的版本，详见更新日志。
            
            ### 安装包说明
            - `*_x64.msi` / `*_x64_setup.exe` - 64位 Windows 安装包
            - `*_x86.msi` / `*_x86_setup.exe` - 32位 Windows 安装包
            - `kernel_*_windows_*.zip` - 浏览器内核压缩包

